---
title: "NPB Requirements"
output: html_notebook
---


```{r}
library(httr)
library(rlist)
library(dplyr)
library(reactable)
library(devtools)
library(jsonlite)
library(tidyverse)
library(flextable)
library(officer)
#install_github("jeroenooms/jsonlite")
#eores<-"https://eorestest.nesdis-hq.noaa.gov/ws/ws/"
#eores<-https://eoreswstest2.nesdis-hq.noaa.gov/ws/ws/"
#eores<-"https://eores.nesdis-hq.noaa.gov/ws/ws/"
eores<-"https://eores.nesdis-hq.noaa.gov/ws/ws/"

#treename<-"EOA2016"
treename<-"NOSIA-II"
#treename<-"NOSIA-2-1"

#systems
r<-GET(paste0(eores,"get_reports_observing_system_basic_information",sep=""))
json_text<-content(r, as = "text")
systems_json<-fromJSON(json_text)
systems<-systems_json[['rptsystembasic']]

#gcmd master
r<-GET(paste0(eores,"get_reports_gcmd_master",sep=""))
json_text<-content(r, as = "text")
gcmd_json<-fromJSON(json_text)
gcmd<-poh_json[['rptgcmdmaster']]

#platforms
r<-GET(paste0(eores,"get_reports_platform_basic_information",sep=""))
json_text<-content(r, as = "text")
platforms_json<-fromJSON(json_text)
platforms<-platforms_json[['rptpltfrmbasic']]

#platforms2system
r<-GET(paste0(eores,"get_reports_observing_system_platform_associations",sep=""))
json_text<-content(r, as = "text")
platform2system_json<-fromJSON(json_text)
platform2system<-platform2system_json[['rptsystem2pltfrm']]

#Sensing Elements
r<-GET(paste0(eores,"get_reports_sensing_element_basic_information",sep=""))
json_text<-content(r, as = "text")
se_json<-fromJSON(json_text)
se<-se_json[['rptsebasic']]

#se2platform
r<-GET(paste0(eores,"get_reports_platform_sensing_element_associations",sep=""))
json_text<-content(r, as = "text")
se2platform_json<-fromJSON(json_text)
se2platform<-se2platform_json[['rptpltfrm2se']]

#environmental parameters
r<-GET(paste0(eores,"get_reports_environmental_parameter_basic_information",sep=""))
json_text<-content(r, as = "text")
ep_json<-fromJSON(json_text)
ep<-ep_json[['rptenvparambasic']]

#se2ep
r<-GET(paste0(eores,"get_reports_sensing_element_environmental_parameter_associations",sep=""))
json_text<-content(r, as = "text")
ep2se_json<-fromJSON(json_text)
ep2se<-ep2se_json[['rptse2envparam']]

#eorbasic
r<-GET(paste0(eores,"get_reports_eor_basic_information",sep=""))
json_text<-content(r, as = "text")
eorbasic_json<-fromJSON(json_text)
eorbasic<-eorbasic_json[['rpteorbasic']]

#eorgcmd
r<-GET(paste0(eores,"get_reports_eor_gcmd_information",sep=""))
json_text<-content(r, as = "text")
eorgcmd_json<-fromJSON(json_text)
eorgcmd<-eorgcmd_json[['rpteorgcmd']]

#eor_ext_attributes
r<-GET(paste0(eores,"get_reports_eor_extended_attribute_information",sep=""))
json_text<-content(r, as = "text")
eorextattr_json<-fromJSON(json_text)
eorextattr<-eorextattr_json[['rpteorextattrib']]
eorextattr <- eorextattr %>%
  select(requirement_id, level, ods_flt_hrs_hods, ods_flt_hrs_hods_units)

#eor_attribute
r<-GET(paste0(eores,"get_reports_eor_standard_attribute_information",sep=""))
json_text<-content(r, as = "text")
eorattr_json<-fromJSON(json_text)
eorattr<-eorattr_json[['rpteorstdattrib']]
eorattr<- eorattr %>%
  select(-ends_with(c("_trend","_weight","_notes","_performance_score"))) %>%
  left_join(eorextattr, by = c("requirement_id","level")) %>%
  filter(is.na(ods_flt_hrs_hods)) %>%
  filter(is.na(ods_flt_hrs_hods_units)) %>%
  select(-ods_flt_hrs_hods, -ods_flt_hrs_hods_units)

#eor_poh
r<-GET(paste0(eores,"get_reports_eor_organizational_affiliations",sep=""))
json_text<-content(r, as = "text")
eor_poh_json<-fromJSON(json_text)
eor_poh<-eor_poh_json[['rpteororgs']]

#eor_vt
r<-GET(paste0(eores,"get_reports_eor_value_tree_connections",sep=""))
json_text<-content(r, as = "text")
eor_vt_json<-fromJSON(json_text)
eor_vt<-eor_vt_json[['rpteorvti']]
```


#NPB Joins for Requirements Output (for Lauraleen)
```{r}
#### System joins ####
npb_system_joins <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  mutate(gcmd_path = paste0(gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2)) %>%
  distinct(gcmd_path, .keep_all = TRUE) %>%
  select(system_name, system_acronym, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2, gcmd_path) %>%
  filter(gcmd_path != "NANANANA")

#IWPI in req name, fill in WRN_IWPI in MSA
#attr level as rows
#add goal
#pwx for rwx where it's NA


#### Deal with gcmds to match up to systems ####

eorbasic_filter<- eorbasic %>%
  filter(requirement_id %in% eorattr$requirement_id) %>%
  filter(requirement_status=="ACTIVE") %>%
  filter(!is.na(requirement_name))

npb_eor_gcmd<- eorgcmd %>%
  mutate(gcmd_path = paste0(primary_gcmd_topic, primary_gcmd_term, primary_gcmd_variable, primary_gcmd_variable_l2)) %>%
  filter(requirement_id %in% eorbasic_filter$requirement_id) %>%
  select(requirement_id, gcmd_path, primary_gcmd_topic, primary_gcmd_term, primary_gcmd_variable, primary_gcmd_variable_l2)

#### Join npb system unique gcmds to eor ####
npb_joins <- npb_system_joins %>%
  full_join(npb_eor_gcmd, by = "gcmd_path") %>% 
  filter(!is.na(system_name)) %>%
  select(requirement_id, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2, system_name, gcmd_path) %>%
  full_join(eorbasic_filter, by = "requirement_id") %>% 
  filter(!is.na(system_name)) %>%
  select(system_name, requirement_id, requirement_name, requirement_source, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2, system_name, gcmd_path) %>%
  full_join(eor_poh, by = "requirement_id") %>%
  filter(!is.na(system_name)) %>%
  select(system_name, requirement_id, requirement_name, requirement_source, level_4_short_name, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2, system_name, gcmd_path) %>%
  full_join(eor_vt, by = "requirement_id") %>% 
  filter(!is.na(system_name)) %>%
  select(system_name, requirement_id, requirement_name, requirement_source, level_4_short_name, value_tree_level_2, value_tree_level_3, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  mutate(requirement_source = replace(requirement_source, is.na(requirement_source), "COURL")) %>%
  mutate(value_tree_level_3 = replace(value_tree_level_3, grep("IWPI",requirement_name), "WRN_IWPI")) %>%
  mutate(value_tree_level_3 = replace(value_tree_level_3, value_tree_level_3=="WRN_RWX", "WRN_PWX")) %>% 
  mutate(value_tree_level_3 = replace(value_tree_level_3, requirement_source %in% c("WMO","SPRWG","USGEO SNWG"), "TBS")) %>% 
  mutate(value_tree_level_2 = replace(value_tree_level_2, requirement_source %in% c("WMO","SPRWG","USGEO SNWG"), "TBS")) %>%
  mutate(value_tree_level_2 = replace(value_tree_level_2, value_tree_level_3 == "WRN_IWPI", "WRN")) %>% 
  full_join(eorattr, by = "requirement_id") %>% 
  filter(!is.na(system_name)) %>%
  mutate(attr_all = paste0(geographic_coverage,horizontal_resolution, horizontal_resolution_units, measurement_accuracy, measurement_accuracy_units, sampling_interval, sampling_interval_units, vertical_resolution, vertical_resolution_units)) %>% 
  filter(attr_all != "NANANANANANANANANA") %>% select(-attr_all, -system_name) %>%
  dplyr::rename(`NOAA Line Office` = level_4_short_name,
         MSA = value_tree_level_3,
         Goal = value_tree_level_2,
         `Attribute Level` = level,
         `Refresh Rate` = sampling_interval,
         `Refresh Rate Units` = sampling_interval_units,
         `Environmental Variable` = gcmd_variable)
write.csv(npb_joins, "C:/Users/Elizabeth.Gugliotti/Documents/code/output/npb_requirements.csv", row.names = FALSE)
```


# NPB Joins for Tableau Dashboard Data Template (for Lauraleen)
```{r}
npb_system_tableau <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  mutate(product_category = "Sensor Data") %>%
  select(platform_name, product_category, sensing_element_name, environmental_parameter_name, sensing_element_description, gcmd_topic, gcmd_term, gcmd_variable, geographic_coverage, sampling_interval, sampling_interval_units) %>%
  mutate(sensing_element_name = as.character(sensing_element_name)) %>%
  mutate(product_category = replace(product_category, which(sensing_element_name == "Imagery Products"), "Imagery")) %>%
  mutate(product_category = replace(product_category, which(sensing_element_name %in% c("Atmospheric Composition and Air Quality Products", "Atmospheri Water Vapor Products", "Atmospheric Temperature Products", "Clouds Products", "Lightning Products", "Precipitation Products", "Radiation Budget Products", "Tropical Cyclone Characteristics Products", "Volanic Eruption Characteristics Products", "Winds Products")), "Atmosphere")) %>%
  mutate(product_category = replace(product_category, which(sensing_element_name %in% c("Lake and Sea Ice Products", "Snow and Glacier Products")), "Cryosphere")) %>%
  mutate(product_category = replace(product_category, which(sensing_element_name %in% c("Flood Products", "Surface Moisture Products","Fires Products","Surface Temperature Products", "Vegetation Products")), "Land and Surface Hydrology")) %>%
  mutate(product_category = replace(product_category, which(sensing_element_name %in% c("Biology and Biogeochemistry Products", "Surface Height Products","Topography and Bathymetry Products","Water Pollution Products", "Water Temperature and Salinity Products")), "Oceans, Freshwater and Coasts")) %>%
  mutate(product_category = replace(product_category, which(sensing_element_name %in% c("Heliosphere Products", "Ionosphere Products","Magnetosphere Products","Solar Products")), "Space")) %>%
  separate(platform_name, c("Thematic Product Area", "extra"), extra = "drop", sep = " Product") %>%
  select(-extra) %>%
  separate(sensing_element_name, c("Product Sub-Category", "extra"), extra = "drop", sep = " Product") %>%
  select(-extra) %>%
  separate(environmental_parameter_name, c("Baseline Product", "extra"), extra = "drop", sep = " Baseline Product") %>%
  select(-extra) %>%
  dplyr::rename(`Product Sub-Category Description` = sensing_element_description) %>%
  dplyr::rename(`Product Category` = product_category,
                `Refresh Rate` = sampling_interval,
                `Refresh Rate Units` = sampling_interval_units,
                `Environmental Variable` = gcmd_variable)
write.csv(npb_system_tableau, "C:/Users/Elizabeth.Gugliotti/Documents/code/output/npb_tableau_template.csv", row.names = FALSE)
```


Just baseline product name with unique gcmd pathways (for Lewis)
```{r}
product_pathways<- npb_system_tableau %>%
  select(-geographic_coverage, -`Refresh Rate`, -`Refresh Rate Units`) %>%
  mutate(combo = paste0(`Product Sub-Category`, `Baseline Product`,gcmd_topic,gcmd_term,`Environmental Variable`)) %>%
  distinct(combo, .keep_all = TRUE) %>% 
  filter(`Thematic Product Area` != "Analytical") %>%
  select(`Baseline Product`, `Environmental Variable`)
write.csv(product_pathways, "C:/Users/Elizabeth.Gugliotti/Documents/code/output/product_and_pathways.csv", row.names = FALSE)
```



3. Include product name Priority 1 Active requirements from above filter (no WMO, SPRWG, SNWG) so...how many of these products have a priority
```{r}
npb_system_joins2 <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  select(system_name, sensing_element_name, environmental_parameter_name, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  separate(environmental_parameter_name, c("Baseline Product", "extra"), extra = "drop", sep = " Baseline Product") %>%
  mutate(gcmd_path = paste0(sensing_element_name, `Baseline Product`,gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2)) %>%
  distinct(gcmd_path, .keep_all = TRUE) %>%
  filter(gcmd_path != "NANANANA") %>% 
  dplyr::select(-gcmd_path, -extra, -system_name)


#gcmds
npb_eor_gcmd2 <- npb_eor_gcmd %>%
  rename(gcmd_topic = primary_gcmd_topic,
         gcmd_term = primary_gcmd_term,
         gcmd_variable = primary_gcmd_variable,
         gcmd_variable_l2 = primary_gcmd_variable_l2) %>%
  dplyr::select(-gcmd_path)


#requirement attributes as columns instead of rows
objective<- eorattr %>%
  filter(level == "Objective") %>%
  rename_with(~paste("objective", .x, sep = "_")) %>%
  rename(requirement_id = objective_requirement_id) %>%
  select(-objective_level) %>%
  mutate_all(na_if,"")
threshold<- eorattr %>%
  filter(level == "Threshold") %>%
  rename_with(~paste("threshold", .x, sep = "_")) %>%
  rename(requirement_id = threshold_requirement_id) %>%
  select(-threshold_level) %>%
  mutate_all(na_if,"")
eorattr_cols<- threshold %>%
  full_join(objective, by = "requirement_id")


# joins and data wrangling
npb_joins_priority1_active <- npb_system_joins2 %>%
  left_join(npb_eor_gcmd2, by = c("gcmd_topic","gcmd_term","gcmd_variable","gcmd_variable_l2")) %>%
  left_join(eorbasic, by = "requirement_id") %>%
  select(sensing_element_name, `Baseline Product`, requirement_id, requirement_name, requirement_source, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  filter(requirement_priority ==1) %>%
  filter(requirement_status == "ACTIVE") %>%
  left_join(eor_poh, by = "requirement_id") %>%
  select(sensing_element_name, `Baseline Product`, requirement_id, requirement_name, requirement_source, level_4_short_name, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  left_join(eor_vt, by = "requirement_id") %>% 
  select(sensing_element_name, `Baseline Product`, requirement_id, requirement_name, requirement_source, level_4_short_name, value_tree_level_2, value_tree_level_3, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  mutate(requirement_source = replace(requirement_source, is.na(requirement_source), "COURL")) %>%
  mutate(value_tree_level_3 = replace(value_tree_level_3, grep("IWPI",requirement_name), "WRN_IWPI")) %>%
  mutate(value_tree_level_3 = replace(value_tree_level_3, value_tree_level_3=="WRN_RWX", "WRN_PWX")) %>% 
  mutate(value_tree_level_3 = replace(value_tree_level_3, requirement_source %in% c("WMO","SPRWG","USGEO SNWG"), "TBS")) %>% 
  mutate(value_tree_level_2 = replace(value_tree_level_2, requirement_source %in% c("WMO","SPRWG","USGEO SNWG"), "TBS")) %>%
  mutate(value_tree_level_2 = replace(value_tree_level_2, value_tree_level_3 == "WRN_IWPI", "WRN")) %>% 
  filter(!requirement_source %in% c("WMO","SPRWG","USGEO SNWG")) %>% 
  left_join(eorattr_cols, by = "requirement_id") %>% 
  dplyr::rename(line_office = level_4_short_name,
         MSA = value_tree_level_3,
         goal = value_tree_level_2) %>% select(-sensing_element_name)

write.csv(npb_joins_priority1_active, "C:/Users/Elizabeth.Gugliotti/Documents/code/output/npb_priority1_active_requirements.csv", row.names = FALSE)
```


Product Baseline > GCMD's > Requirement ID, Name, Priority, Type 
Summary by Baseline Product and Priority/Type
```{r}
npb_system_joins2 <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  select(system_name, sensing_element_name, environmental_parameter_name, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  separate(environmental_parameter_name, c("Baseline Product", "extra"), extra = "drop", sep = " Baseline Product") %>%
  mutate(gcmd_path = paste0(sensing_element_name,`Baseline Product`,gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2)) %>%
  distinct(gcmd_path, .keep_all = TRUE) %>%
  dplyr::select(-gcmd_path, -extra, -system_name)


#gcmds
npb_eor_gcmd2 <- eorgcmd %>%
  select(requirement_id, primary_gcmd_topic, primary_gcmd_term, primary_gcmd_variable, primary_gcmd_variable_l2) %>%
  rename(gcmd_topic = primary_gcmd_topic,
         gcmd_term = primary_gcmd_term,
         gcmd_variable = primary_gcmd_variable,
         gcmd_variable_l2 = primary_gcmd_variable_l2)


# joins and data wrangling
reqs2npb <- npb_system_joins2 %>%
  full_join(npb_eor_gcmd2, by = c("gcmd_topic","gcmd_term","gcmd_variable","gcmd_variable_l2")) %>% 
  filter(!is.na(`Baseline Product`)) %>%
  left_join(eorbasic[eorbasic$requirement_id %in% eorattr$requirement_id,], by = "requirement_id") %>%
  select(sensing_element_name, `Baseline Product`, requirement_id, requirement_name, requirement_source, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  filter(requirement_status %in% c("ACTIVE", NA)) %>% 
  select(sensing_element_name, `Baseline Product`, requirement_id, requirement_name, requirement_source, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  select(sensing_element_name, `Baseline Product`, requirement_id, requirement_name, requirement_source, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  mutate(requirement_source = replace(requirement_source, is.na(requirement_source), "COURL")) %>%
  mutate(requirement_source = ifelse(requirement_source == "COURL", paste0(requirement_source," ", requirement_priority), requirement_source)) %>% 
  mutate(requirement_source = ifelse(requirement_source == "COURL NA", NA, requirement_source)) %>% 
  rename(`Product Sub-Category` = sensing_element_name)

write.csv(reqs2npb, "C:/Users/Elizabeth.Gugliotti/Documents/code/output/reqs2npb_no_attributes.csv", row.names = FALSE)

# create data for tables
summary_reqs2npb<- reqs2npb %>%
  group_by(`Product Sub-Category`,`Baseline Product`) %>%
  summarize(`Relevant Environmental Variables` = paste("-", unique(gcmd_variable), collapse = "\n"),
            requirement_source = requirement_source) %>%
  as.data.frame() %>%
  group_by(`Product Sub-Category`, `Baseline Product`, requirement_source) %>%
  summarize(count_by_source = n(),
            `Relevant Environmental Variables` =`Relevant Environmental Variables`) %>%
  as.data.frame() %>%
  mutate(`Requirement Source` = paste0("- ",requirement_source, " = ", count_by_source))%>%
  mutate(`Requirement Source` = ifelse(is.na(requirement_source),"", `Requirement Source`)) %>%
  as.data.frame() %>%
  group_by(`Product Sub-Category`, `Baseline Product`, `Relevant Environmental Variables`) %>%
  summarize(`Requirement Source` = paste(unique(`Requirement Source`), collapse = "\n")) 
  as.data.frame() %>%
  distinct(`Product Sub-Category`,`Baseline Product`, `Requirement Source`, `Relevant Environmental Variables`, .keep_all = TRUE) 

overall_summary_reqs2npb<- reqs2npb %>%
  group_by(`Product Sub-Category`,`Baseline Product`) %>%
  summarize(`Relevant Environmental Variables` = paste("-", unique(gcmd_variable), collapse = "\n"),
            requirement_source = requirement_source,
            overall_reqs = n()) %>%
  as.data.frame() %>% 
  group_by(`Product Sub-Category`, `Baseline Product`, requirement_source) %>%
  summarize(count_by_source = n(),
            `Relevant Environmental Variables` =`Relevant Environmental Variables`,
            overall_reqs = overall_reqs) %>%
  as.data.frame() %>%
  mutate(`Requirement Source` = paste0("- ",requirement_source, " = ", count_by_source))%>%
  mutate(`Requirement Source` = ifelse(is.na(requirement_source),"", `Requirement Source`)) %>%
  as.data.frame() %>%
  group_by(`Product Sub-Category`, `Baseline Product`, `Relevant Environmental Variables`) %>%
  summarize(`Requirement Source` = paste(unique(`Requirement Source`), collapse = "\n"),
            `Total Number of Requirements` = overall_reqs) %>%
  as.data.frame() %>%
  distinct(`Product Sub-Category`, `Baseline Product`, `Requirement Source`, `Relevant Environmental Variables`, .keep_all = TRUE)


#1st flextable without total number of reqs per baseline product
ft_1<-flextable(summary_reqs2npb)
ft_1<-theme_box(ft_1)
ft_1<-merge_v(ft_1, j = "Product Sub-Category",
              target = c("Baseline Product", "Product Sub-Category"))
ft_2<-merge_v(ft_1, j = "Baseline Product",
              target = c("Baseline Product","Relevant Environmental Variables"))
ft_2<-width(ft_2, width = 1.75)

#2nd flextable with total number of reqs per baseline product
ft_reqs<-flextable(overall_summary_reqs2npb)
ft_reqs<-theme_box(ft_reqs)
ft_reqs<-merge_v(ft_reqs, j = "Product Sub-Category",
              target = c("Baseline Product", "Product Sub-Category"))
ft_reqs2<-merge_v(ft_reqs, j = "Baseline Product",
              target = c("Baseline Product","Relevant Environmental Variables"))
ft_reqs2<-width(ft_reqs2, width = 1.5)
```


4. % of Baseline Products with at least 1 matched EOR record
          | Foundational Products (total = 27) | Geophysical Products (total = 131) |
COURL P1  |                 XX %               |                 XX %               |   
COURL P2  |                 XX %               |                 XX %               |  
COURL P3  |                 XX %               |                 XX %               |  
SPRWG     |                 XX %               |                 XX %               |  
SNWG      |                 XX %               |                 XX %               |  
WMO       |                 XX %               |                 XX %               |  

```{r}
npb_system_joins2 <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  select(system_name, platform_name, sensing_element_name, environmental_parameter_name, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  separate(environmental_parameter_name, c("Baseline Product", "extra"), extra = "drop", sep = " Baseline Product") %>%
  mutate(gcmd_path = paste0(sensing_element_name,`Baseline Product`,gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2)) %>%
  distinct(gcmd_path, .keep_all = TRUE) %>%
  dplyr::select( -extra, -system_name)


#gcmds
npb_eor_gcmd2 <- eorgcmd %>%
  select(requirement_id, primary_gcmd_topic, primary_gcmd_term, primary_gcmd_variable, primary_gcmd_variable_l2) %>%
  rename(gcmd_topic = primary_gcmd_topic,
         gcmd_term = primary_gcmd_term,
         gcmd_variable = primary_gcmd_variable,
         gcmd_variable_l2 = primary_gcmd_variable_l2)

eorbasic_filter_separately <- eorbasic %>%
  left_join(npb_eor_gcmd2, by = "requirement_id") %>%
  filter(requirement_status=="ACTIVE") %>%
  filter(requirement_id %in% eorattr$requirement_id) %>%
  filter(!is.na(requirement_name))
  
# joins and data wrangling
reqs2npb <- npb_system_joins2 %>%
  full_join(eorbasic_filter_separately, by = c("gcmd_topic","gcmd_term","gcmd_variable","gcmd_variable_l2")) %>%
  select(platform_name, sensing_element_name, `Baseline Product`, requirement_id, requirement_name, requirement_source, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  select(platform_name, sensing_element_name, `Baseline Product`, requirement_id, requirement_name, requirement_source, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  select(platform_name, sensing_element_name, `Baseline Product`, requirement_id, requirement_name, requirement_source, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  mutate(requirement_source = replace(requirement_source, is.na(requirement_source), "COURL")) %>%
  mutate(requirement_source = ifelse(requirement_source == "COURL", paste0(requirement_source," ", requirement_priority), requirement_source)) %>% 
  mutate(requirement_source = replace(requirement_source, requirement_source=="COURL NA", NA)) %>%
  distinct(platform_name, sensing_element_name, `Baseline Product`,requirement_source, .keep_all = TRUE) %>%
  filter(platform_name %in% c("Geophysical Products - NESDIS Products Baseline", "Foundational Products - NESDIS Products Baseline")) %>%
  mutate(sensing_npb_name = paste0(sensing_element_name, `Baseline Product`))

filter_npb_table <- reqs2npb %>%
  group_by(platform_name) %>%
  summarize(sensing_element_name = sensing_element_name,
            `Baseline Product` = `Baseline Product`,
            requirement_source = requirement_source,
            all_count = n_distinct(sensing_npb_name),
            sensing_npb_name = sensing_npb_name) %>% 
  as.data.frame() %>%
  group_by(platform_name, requirement_source) %>%
  summarize(sensing_element_name = sensing_element_name,
            `Baseline Product` = `Baseline Product`,
            all_count = all_count,
            source_count = n_distinct(sensing_npb_name),
            pcent_source = paste0(round((source_count/all_count)*100, 2)," %")) %>%
  as.data.frame() %>%
  separate(platform_name, c("platform_name", "extra"), sep = " -", extra = "drop") %>%
  mutate(product_category =  paste0(platform_name,"\n","(total =", all_count,")")) %>%
  mutate(requirement_source = replace(requirement_source, is.na(requirement_source), "No Requirements")) %>%
  select(product_category, requirement_source, pcent_source) %>%
  distinct(product_category, requirement_source, .keep_all = TRUE) %>%
  pivot_wider(names_from = product_category, values_from = pcent_source) %>% 
  rename(" " = requirement_source)


ft_prods<-flextable(filter_npb_table)
ft_prods<-theme_box(ft_prods)
ft_prods<-align(ft_prods, align = "center", part = "header")
ft_prods<-width(ft_prods, width = 2.25)
ft_prods
```

Output Tables to Word Doc
```{r}
read_docx() %>%
  body_add_par("Number of Baseline Products = 153 (26 Foundational & 127 Geophysical") %>%
  body_add_par("Number of Baseline Products with at least 1 requirement = 136") %>%
  body_add_par("Number of Baseline Products with no requirement match = 17") %>%
  body_add_par("Number of Baseline Products with no GCMD match = 6") %>%
  body_add_par(" ") %>%
  body_add_par("Table Not Including Total # of Requirements per Baseline Product") %>%
  body_add_flextable(value= ft_2) %>%
  body_add_par("Table Including Total # of Requirements per Baseline Product") %>%
  body_add_flextable(value =ft_reqs2) %>%
  body_add_par(" ") %>%
  body_add_par(" ") %>%
  body_add_par("% of Baseline Products with at Least 1 Matched EOR Record by Source") %>%
  body_add_flextable(value =ft_prods) %>%
  print(target = "C:/Users/Elizabeth.Gugliotti/Documents/code/output/npb_flextable_word.docx")
```


Lewis Ask #3

1. Total Unique Baseline Products in the Foundational and Geophysical Categories (should be 153: 26 Foundational, 127 Geophysical)
# The number I got is different then what Lewis originally got because they had two products named the same thing under different sub-topics.
```{r}
####Unique Products by their attributes (F = 43, G = 286)####
npb_system_joins2 <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  select(system_name, platform_name, sensing_element_name, environmental_parameter_name, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  separate(environmental_parameter_name, c("Baseline Product", "extra"), extra = "drop", sep = " Baseline Product") %>% 
  separate(extra, c("stuff","unique_id")) %>% 
  select(-stuff) %>% 
  group_by(platform_name) %>%
  distinct(platform_name, unique_id, .keep_all = TRUE) %>%
  summarize(unique_products = n()) %>% View()

####Unique Products by their Product names (F = 26, G = 127)####
npb_system_joins2 <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  select(system_name, platform_name, sensing_element_name, environmental_parameter_name, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  separate(environmental_parameter_name, c("Baseline Product", "extra"), extra = "drop", sep = " Baseline Product") %>% 
  separate(extra, c("stuff","unique_id")) %>% 
  select(-stuff) %>% 
  group_by(platform_name) %>%
  distinct(platform_name, sensing_element_name, `Baseline Product`, .keep_all = TRUE) %>%
  summarize(unique_products = n()) %>% View()
```


2. Number of Baseline Products with at least 1 EOR match based on GCMD variable: actually 136
```{r}
####data wrangling####
npb_system_joins2 <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  select(system_name, platform_name, sensing_element_name, environmental_parameter_name, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  separate(environmental_parameter_name, c("Baseline Product", "extra"), extra = "drop", sep = " Baseline Product") %>% 
  mutate(gcmd_path = paste0(sensing_element_name,`Baseline Product`,gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2)) %>%
  distinct(gcmd_path, .keep_all = TRUE) %>%
  dplyr::select( -extra, -system_name)

#gcmds
npb_eor_gcmd2 <- eorgcmd %>%
  select(requirement_id, primary_gcmd_topic, primary_gcmd_term, primary_gcmd_variable, primary_gcmd_variable_l2) %>%
  rename(gcmd_topic = primary_gcmd_topic,
         gcmd_term = primary_gcmd_term,
         gcmd_variable = primary_gcmd_variable,
         gcmd_variable_l2 = primary_gcmd_variable_l2)


####Get table of baseline products with 1 eor match = 137####
reqs2npb_1req_or_more <- npb_system_joins2 %>%
  full_join(npb_eor_gcmd2, by = c("gcmd_topic","gcmd_term","gcmd_variable","gcmd_variable_l2")) %>%
  full_join(eorbasic, by = "requirement_id") %>%
  select(platform_name, sensing_element_name, `Baseline Product`, requirement_id, requirement_name, requirement_source, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2, gcmd_path) %>%
  filter(requirement_status == "ACTIVE") %>%
  filter(requirement_id %in% eorattr$requirement_id) %>%
  select(platform_name, sensing_element_name, `Baseline Product`, requirement_id, requirement_name, requirement_source, requirement_priority, requirement_status, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2, gcmd_path) %>% 
  filter(!is.na(platform_name)) %>% 
  distinct(sensing_element_name, `Baseline Product`, .keep_all = TRUE) %>% 
  mutate(sub_area_baseline_name = paste0(sensing_element_name, `Baseline Product`))

View(reqs2npb_1req_or_more)
```


3. Number of Baseline Products with no matched EOR records = 17
```{r}
bp_no_eor <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  select(system_name, platform_name, sensing_element_name, environmental_parameter_name, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  separate(environmental_parameter_name, c("Baseline Product", "extra"), extra = "drop", sep = " Baseline Product") %>% 
  mutate(sub_area_baseline_name = paste0(sensing_element_name, `Baseline Product`)) %>%
  distinct(sensing_element_name, `Baseline Product`, .keep_all = TRUE) %>%
  filter(!(sub_area_baseline_name %in% reqs2npb_1req_or_more$sub_area_baseline_name)) %>% 
  filter(platform_name != "Analytical Products - NESDIS Product Baseline") %>% View()
```


NPB Products with their gcmd pathways
```{r}
npb_system_joins_options <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  select(system_name, platform_name, sensing_element_name, environmental_parameter_name, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  separate(environmental_parameter_name, c("Baseline Product", "extra"), extra = "drop", sep = " Baseline Product") %>% 
  mutate(gcmd_path = paste0(sensing_element_name,`Baseline Product`,gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2)) %>%
  distinct(gcmd_path, .keep_all = TRUE) %>%
  dplyr::select( -extra, -system_name) %>% 
  separate(platform_name, c("Category", "extra"), extra = "drop", sep = " Products - ") %>% 
  select(-extra, -gcmd_topic, -gcmd_term, -gcmd_path, -gcmd_variable_l2) %>%
  group_by(sensing_element_name, `Baseline Product`) %>%
  mutate(id = paste0("GCMD ", row_number())) %>%
  as.data.frame() %>%
  pivot_wider(names_from = "id", values_from = "gcmd_variable") %>%
  mutate(`GCMD 1` =replace_na(`GCMD 1`," ")) %>%
  mutate(`GCMD 2` =replace_na(`GCMD 2`," ")) %>%
  mutate(`GCMD 3` =replace_na(`GCMD 3`," ")) %>%
  mutate(`GCMD 4` =replace_na(`GCMD 4`," ")) %>%
  mutate(`GCMD 5` =replace_na(`GCMD 5`," ")) %>%
  mutate(`GCMD 6` =replace_na(`GCMD 6`," ")) %>%
  filter(Category != "Analytical") %>%
  separate(sensing_element_name, c("Sub-Category", "extra"), extra = "drop", sep = " Products") %>% 
  select(-extra) %>%
  write.csv("C:/Users/Elizabeth.Gugliotti/Documents/code/output/npb_gcmd_options.csv", row.names = FALSE)
```

Our GCMD's not in Lou's list and Lou's GCMD's not in our list
```{r}
lous_analysis_gcmds<- read.csv("C:/Users/Elizabeth.Gugliotti/Documents/code/input/lous_analysis_gcmds.csv", header = TRUE)

npb_system_joins_options <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  select(system_name, platform_name, sensing_element_name, environmental_parameter_name, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  separate(environmental_parameter_name, c("Baseline Product", "extra"), extra = "drop", sep = " Baseline Product") %>% 
  mutate(gcmd_path = paste0(sensing_element_name,`Baseline Product`,gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2)) %>%
  distinct(gcmd_path, .keep_all = TRUE) %>%
  dplyr::select( -extra, -system_name) %>% 
  separate(platform_name, c("Category", "extra"), extra = "drop", sep = " Products - ") %>% 
  select(-extra, -gcmd_topic, -gcmd_term, -gcmd_path, -gcmd_variable_l2) %>%
  as.data.frame() %>%
  filter(Category != "Analytical") %>%
  separate(sensing_element_name, c("Sub-Category", "extra"), extra = "drop", sep = " Products") %>% 
  select(-extra)

ours_not_in_lous <- npb_system_joins_options %>%
  distinct(gcmd_variable, .keep_all = TRUE) %>%
  filter(!gcmd_variable %in% lous_analysis_gcmds$Full.List.of.GCMD.Pathways.Evaluated) %>%
  filter(!is.na(gcmd_variable)) %>%
  select(gcmd_variable) %>%
  rename(`NPB Variables Not in Lou's Analysis Variables`=gcmd_variable)


lous_not_in_ours <- lous_analysis_gcmds %>%
  filter(!Full.List.of.GCMD.Pathways.Evaluated %in% npb_system_joins_options$gcmd_variable) %>%
  rename(`Lou's Analysis Variables not in NPB Variables` =Full.List.of.GCMD.Pathways.Evaluated)



library(writexl)
sheets<- list("NPB Vars Not in Analysis Vars"= ours_not_in_lous, "Analysis Vars not in NPB Vars" = lous_not_in_ours)
write_xlsx(sheets,"C:/Users/Elizabeth.Gugliotti/Documents/code/output/mismatch_gcmd_variables.xlsx")
```

NPB with yes/no for Priority 1 requirement
```{r}
npb_system_joins5 <- systems %>%
  filter(system_acronym == "NPB") %>%
  left_join(platform2system, by = "system_id") %>%
  left_join(platforms, by = "platform_id") %>%
  left_join(se2platform, by = "platform_id") %>%
  left_join(se, by = "sensing_element_id") %>%
  left_join(ep2se, by = "sensing_element_id") %>%
  left_join(ep, by = "environmental_parameter_id") %>%
  select(system_name, sensing_element_name, environmental_parameter_name, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  separate(environmental_parameter_name, c("Baseline Product", "extra"), extra = "drop", sep = " Baseline Product") %>%
  mutate(gcmd_path = paste0(sensing_element_name, `Baseline Product`,gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2)) %>%
  distinct(gcmd_path, .keep_all = TRUE) %>%
  dplyr::select(-gcmd_path, -extra, -system_name)


#gcmds
npb_eor_gcmd5 <- eorgcmd %>%
  select(requirement_id, primary_gcmd_topic, primary_gcmd_term, primary_gcmd_variable, primary_gcmd_variable_l2) %>%
  rename(gcmd_topic = primary_gcmd_topic,
         gcmd_term = primary_gcmd_term,
         gcmd_variable = primary_gcmd_variable,
         gcmd_variable_l2 = primary_gcmd_variable_l2)


#filter reqs
npb_eor_p1_active_noDAS<-eorbasic %>%
  filter(requirement_priority ==1) %>%
  filter(requirement_status == "ACTIVE") %>%
  filter(!is.na(requirement_name)) %>%
  filter(requirement_id %in% eorattr$requirement_id)
  
# joins and data wrangling
npb_joins_priority1_active_yes <- npb_system_joins5 %>%
  full_join(npb_eor_gcmd5, by = c("gcmd_topic","gcmd_term","gcmd_variable","gcmd_variable_l2")) %>%
  full_join(npb_eor_p1_active_noDAS, by = "requirement_id") %>%
  filter(!is.na(`Baseline Product`)) %>%
  dplyr::mutate(priority_1_req = ifelse(requirement_priority == 1, "Yes", "No")) %>%
  filter(priority_1_req == "Yes") %>%
  distinct(sensing_element_name,`Baseline Product`, .keep_all = TRUE) %>%
  select(sensing_element_name, `Baseline Product`, priority_1_req, requirement_id, requirement_name, gcmd_topic, gcmd_term, gcmd_variable, gcmd_variable_l2) %>%
  mutate(element_product_name = paste0(sensing_element_name, `Baseline Product`))

npb_joins_all <- npb_system_joins5 %>%
  distinct(sensing_element_name,`Baseline Product`, .keep_all = TRUE) %>%
  mutate(element_product_name = paste0(sensing_element_name, `Baseline Product`)) %>%
  dplyr::mutate(priority_1_req = ifelse(element_product_name %in% npb_joins_priority1_active_yes$element_product_name,"Yes","No")) %>%
  select(sensing_element_name, `Baseline Product`,priority_1_req) %>%
  filter(!grepl("Analytical", sensing_element_name)) %>%
  rename("Sub-Category" = sensing_element_name) %>%
  write.csv("C:/Users/Elizabeth.Gugliotti/Documents/code/output/npb_priority_1_yes.csv", row.names = FALSE)
```


