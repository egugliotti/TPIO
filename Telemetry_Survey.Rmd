---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
 

```{r}
library(rcartocolor)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(RColorBrewer)
library(treemap)
library(tm)
#library(wordcloud)
library(reshape)
# telemetry<-read.csv("C:/Users/Elizabeth.Gugliotti/Documents/code/input/Telemetry User Information Survey 21APR2021.csv", header = TRUE)
telemetry_new<-read.csv("C:/Users/Elizabeth.Gugliotti/Documents/code/input/Telemetry User Information Survey 21APR2021_ALL.csv", header = TRUE)

#light blue, dark blue, pink, tan, orange, red
my_palette <- palette(c( "#048C8C", "#0F1B40", "#D95B7D", "#D9B18F", "#F29D35", "#D93814"))

my_palette_lo <- c("#048C8C", "#0F1B40", "#D95B7D", "#D9B18F", "#F29D35", "#D93814")

my_palette_lo_utility <- c("grey49", "#048C8C", "#0F1B40", "#D95B7D", "#D9B18F", "#F29D35", "#D93814")

#dark blue = buoy tracking, pink = meteorology
my_palette_msa <-c("#0F1B40", "#D95B7D", "#048C8C", "#D9B18F")

my_palette_msa_utility <-c("grey49","#0F1B40", "#D95B7D", "#048C8C", "#D9B18F")
```


Line Office & Office #DONE
```{r}
lo_office<- telemetry_new %>%
  select(line_office, office) %>%
  group_by(line_office,office) %>%
  summarize(lo_count = n()) %>%
  as.data.frame()

lo_office$label <- paste0(lo_office$office,"\n(",lo_office$lo_count,")")
treemap(lo_office,
        index = c("line_office","label"),
        vSize = "lo_count",
        type = "index",
        bg.labels = c("transparent"),
        palette = my_palette,
        fontsize.label = c(20,14),
        fontcolor.labels = c("white","white"),
        fontface.labels = c("bold","bold"),
        fontsize.title = c(20),
        border.lwds = c(5,2),
        border.col = c("white","black"),
        align.labels = list(
          c("left","top"),
          c("center","center")),
        title = "Offices that Submitted Telemetry Surveys")
```


Question 4: Program (STILL WORKING)
```{r, eval = FALSE}
dataset=read.delim("https://raw.githubusercontent.com/TATABOX42/text-mining-in-r/master/dataset.txt", header = FALSE)

dataset_labels <-read.delim("https://raw.githubusercontent.com/TATABOX42/text-mining-in-r/master/labels.txt", header = FALSE)
dataset_labels<-dataset_labels[,1]
dataset_labels_p<-paste("class",dataset_labels,sep="_")
unique_labels<-unique(dataset_labels_p)

dataset_s<- sapply(unique_labels, function(label) list(dataset[dataset_labels_p %in%label,1]))

dataset_corpus<-lapply(dataset_s, function(x) Corpus(VectorSource(toString(x))))



####With Telemetry Data####
program<-telemetry_new %>% select(X4..Program.or.Observing.System.requiring.telemetry) %>%
  mutate(X4..Program.or.Observing.System.requiring.telemetry=as.charcter(X4..Program.or.Observing.System.requiring.telemetry))
names(program)<-NULL
label_lo<-telemetry_new %>% select(line_office)
names(label_lo)<-NULL
label_lo<-label_lo[,1]
unique_label_lo<-unique(label_lo)

program_s<-sapply(unique_label_lo, function(label) list(program[label_lo%in%label,1]))
View(program_s)
```


Question 5: Average # of PTTs #DONE
```{r}
####MSA####
q5_msa<- telemetry_new %>%
  select(mission_area, X5..What.has.been.the.average...platforms.or.PTTs.routinely.requiring.telemetry..past.3.years.) %>%
  dplyr::rename(number_ptts = X5..What.has.been.the.average...platforms.or.PTTs.routinely.requiring.telemetry..past.3.years.) %>%
  separate_rows(mission_area, sep = "; ") %>%
  mutate(number_ptts = as.numeric(number_ptts)) %>%
  filter(number_ptts != 0)

q5_msa_mean<- q5_msa %>%
  group_by(mission_area) %>%
  summarize(msa_mean = mean(number_ptts))

ggplot(q5_msa, aes(x=stringr::str_wrap(mission_area,20), y=number_ptts, fill=mission_area)) +
#  geom_violin(width = 1.3) + 
  geom_boxplot()+
  ylim(0,700) + 
  scale_fill_manual(values = my_palette_msa) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.position = "none") +
  labs(x = "Mission Area", y = "Average Number of PTTs", fill = "Mission Area") +
  ggplot2::annotate("text", x = c(1,2,3,4), y = 700, label = c("","+2 outliers","+2 outliers",""), size = 4.9, fontface = 2) +
  ggplot2::annotate("text", x = c(1,2,3,4), y = 675, label = c("mean = 52.0","mean = 2478.3","mean = 1968.3","mean = 30.0"), size = 5.2, fontface = 2) +
  scale_y_continuous(limits = c(0, 725), expand = c(0.01,0))

####LO####

q5_lo<- telemetry_new %>%
  select(line_office, X5..What.has.been.the.average...platforms.or.PTTs.routinely.requiring.telemetry..past.3.years.) %>%
  dplyr::rename(number_ptts = X5..What.has.been.the.average...platforms.or.PTTs.routinely.requiring.telemetry..past.3.years.) %>%
  mutate(number_ptts = as.numeric(number_ptts)) %>%
  filter(number_ptts != 0)

q5_lo_mean<- q5_lo %>%
  group_by(line_office) %>%
  summarize(lo_mean = mean(number_ptts))

ggplot(q5_lo, aes(x=stringr::str_wrap(line_office, 10), y=number_ptts, fill=line_office)) +
#  geom_violin(width = 1.2) + 
  geom_boxplot() +
  ylim(0,700) + 
  scale_fill_manual(values = my_palette_lo) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.position = "none") +
  labs(x = "Line Office", y = "Average Number of PTTs") +
  ggplot2::annotate("text", x = c(1,2,3,4,5), y = 700, label = c("","","","+1 outlier","+1 outlier"), size = 4.9, fontface = 2) +
  ggplot2::annotate("text", x = c(1,2,3,4,5), y = 675, label = c("mean = 27.0","mean = 353.0","mean = 214.8","mean = 475.0","mean = 8260.5"), size = 5.2, fontface = 2)+
  scale_y_continuous(limits = c(0, 725), expand = c(0.01,0))
```


Question 6: Mission Area by Line Office #DONE
```{r}
msa<- telemetry_new %>%
  select(line_office, mission_area) %>%
  separate_rows(mission_area, sep = "; ") %>%
  group_by(line_office, mission_area) %>%
  summarize(msa_count = n()) %>%
  as.data.frame()

ggplot(msa, aes(x = stringr::str_wrap(mission_area,20), y = msa_count, fill = line_office)) +
   geom_bar(position = "stack", stat = "identity") +
   theme_classic() +
   theme(axis.title = element_text(face = "bold", size = rel(1.8)),
         axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
         axis.line = element_line(size = 1),
         legend.title = element_text(face = "bold", size = rel(1.6)),
         legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
         legend.position = c(0.21, 0.88)) +
  labs(x = "Mission Area", y = "Count", fill = "Line Office") + 
  scale_fill_manual(values = my_palette_lo) +
  scale_y_continuous(limits = c(0, 30), expand = c(0.01,0))
```


Question 7: Environmental Variables #DONE
```{r}
variables<-telemetry_new %>%
  select(line_office, mission_area, X7..Environmental.variables.collected..pick.as.many.as.appropriate.) %>%
  dplyr::rename(environmental_variables = X7..Environmental.variables.collected..pick.as.many.as.appropriate.) %>%
  separate_rows(environmental_variables, sep = ";") %>%
  mutate(environmental_variables = ifelse(environmental_variables == "platform or PTT housekeeping (e.g., battery voltage)", "PTT housekeeping (battery voltage)", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "biotelemetry (wildlife range and behavior)", "biotelemetry (wildlife range & behavior)", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "river streamflow data for river stage height", "river stage height", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "Precipitation", "precipitation", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "Emergency communtiction", "emergency communication", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "Doppler Weather Radar ", "doppler weather radar", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "sea temperature (at depth / profiling)", "sea temperature (at depth)", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "algae / algal blooms", "algae/algal blooms", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "camera imagery or video", "camera imagery/video", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "pressure", "atmospheric pressure", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "animal depth", "biotelemetry (wildlife range & behavior)", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "acoustics", "biotelemetry (wildlife range & behavior)", environmental_variables)) %>%
  mutate(environmental_variables = ifelse(environmental_variables == "pressure (depth)", "sea pressure (depth)", environmental_variables))
  

#### MSA ####
variables_msa<-variables %>%
  select(mission_area, environmental_variables) %>%
  mutate(environmental_variables = ifelse(environmental_variables=="temperature", "air temperature", environmental_variables)) %>%
  separate_rows(mission_area, sep = "; ") %>%
  group_by(mission_area, environmental_variables) %>%
  summarize(var_count = n()) %>%
  as.data.frame() %>%
  group_by(environmental_variables) %>%
  summarize(ev_count = sum(var_count),
            var_count = var_count,
            mission_area = mission_area) %>%
  as.data.frame()

ggplot(variables_msa, aes(x = reorder(environmental_variables, -ev_count), y = var_count, fill = stringr::str_wrap(mission_area,36))) +
   geom_bar(position = "stack", stat = "identity") +
   theme_classic() +
   theme(axis.title = element_text(face = "bold", size = rel(1.4)),
         axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
         axis.line = element_line(size = 1),
         legend.title = element_text(face = "bold", size = rel(1.4)),
         legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
         legend.position = c(0.7, 0.895)) +
  labs(x = "Environmental Variables", y = "Count", fill = "Mission Areas") +
  coord_flip() + 
  scale_fill_manual(values = my_palette_msa) +
  scale_y_continuous(limits = c(0, 65), expand = c(0.01,0))

#### LO ####
variables_lo<-variables %>%
  select(line_office, environmental_variables) %>%
  mutate(environmental_variables = ifelse(environmental_variables=="temperature", "air temperature", environmental_variables)) %>%
  group_by(environmental_variables) %>%
  group_by(line_office, environmental_variables) %>%
  summarize(var_count = n()) %>%
  as.data.frame() %>%
  group_by(environmental_variables) %>%
  summarize(ev_count = sum(var_count),
            var_count = var_count,
            line_office = line_office) %>%
  as.data.frame()

ggplot(variables_lo, aes(x = reorder(environmental_variables, -ev_count), y = var_count, fill = line_office)) +
   geom_bar(position = "stack", stat = "identity") +
   theme_classic() +
   theme(axis.title = element_text(face = "bold", size = rel(1.4)),
         axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
         axis.line = element_line(size = 1),
         legend.title = element_text(face = "bold", size = rel(1.4)),
         legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
         legend.position = c(0.745, 0.895)) +
  labs(x = "Environmental Variables", y = "Count", fill = "Line Office") +
  coord_flip() + 
  scale_fill_manual(values = my_palette_lo)+
  scale_y_continuous(limits = c(0, 35), expand = c(0.01,0))
```


Question 10: Platform Operating Environment Heatmap #DONE
```{r}
pltfrm_env<- telemetry_new %>%
  dplyr::select(mission_area, line_office, X10..Indicate.Platform.Operating.Environment..pick.one.row..air..ocean..land..cryosphere..and.pick.one.column..altitude.or.depth...Air., X10..Indicate.Platform.Operating.Environment..pick.one.row..air..ocean..land..cryosphere..and.pick.one.column..altitude.or.depth...Ocean., X10..Indicate.Platform.Operating.Environment..pick.one.row..air..ocean..land..cryosphere..and.pick.one.column..altitude.or.depth...Land., X10..Indicate.Platform.Operating.Environment..pick.one.row..air..ocean..land..cryosphere..and.pick.one.column..altitude.or.depth...Cryosphere.) %>%
  dplyr::rename(air = X10..Indicate.Platform.Operating.Environment..pick.one.row..air..ocean..land..cryosphere..and.pick.one.column..altitude.or.depth...Air.) %>%
  dplyr::rename(ocean = X10..Indicate.Platform.Operating.Environment..pick.one.row..air..ocean..land..cryosphere..and.pick.one.column..altitude.or.depth...Ocean.) %>%
  dplyr::rename(land = X10..Indicate.Platform.Operating.Environment..pick.one.row..air..ocean..land..cryosphere..and.pick.one.column..altitude.or.depth...Land.) %>%
  dplyr::rename(cryosphere = X10..Indicate.Platform.Operating.Environment..pick.one.row..air..ocean..land..cryosphere..and.pick.one.column..altitude.or.depth...Cryosphere.) %>%
  mutate(air = replace(air, air == "", NA)) %>%
  mutate(ocean = replace(ocean, ocean == "", NA)) %>%
  mutate(land = replace(land, land == "", NA)) %>%
  mutate(cryosphere = replace(cryosphere, cryosphere == "", NA)) %>%
  dplyr::rename(Air = air) %>%
  dplyr::rename(Ocean = ocean) %>%
  dplyr::rename(Land = land) %>%
  dplyr::rename(Cryosphere = cryosphere) %>%
  pivot_longer(Air:Cryosphere, names_to = "environment", values_to = "value") %>%
  arrange(value) %>%
  separate_rows(value, sep = ";") %>%
  drop_na(value) %>% 
  mutate(value = ifelse(value == "surface", "Surface", value)) %>%
  mutate(value = ifelse(value == "ocean: 4km-sfc", "Ocean: 4km-sfc", value)) %>%
  mutate(value = ifelse(value == "ocean: 1km-sfc", "Ocean: 1km-sfc", value)) %>%
  mutate(value = ifelse(value == "ocean: 10m-sfc", "Ocean: 10m-sfc", value)) %>%
  mutate(value = ifelse(value == "ocean: 100m-sfc", "Ocean: 100m-sfc", value)) %>%
  mutate(value = ifelse(value == "air: sfc-1km", "Air: sfc-1km", value)) %>%
  mutate(value = ifelse(value == "air: sfc-15km", "Air: sfc-15km", value)) %>%
  mutate(value = ifelse(value == "air: sfc-10m", "Air: sfc-10m", value)) %>%
  mutate(value = ifelse(value == "air: sfc-100m", "Air: sfc-100m", value)) %>%
  mutate(value = factor(value, levels = c("Ocean: 4km-sfc", "Ocean: 1km-sfc", "Ocean: 100m-sfc", "Ocean: 10m-sfc", "Surface","Air: sfc-10m", "Air: sfc-100m", "Air: sfc-1km", "Air: sfc-15km"), ordered = TRUE))

env_sum <- pltfrm_env %>%
  dplyr::select(environment, value) %>%
  mutate(all_count = length(value)) %>%
  group_by(environment, value) %>%
  summarize(value_count = n(),
            pcent_value = (value_count/unique(all_count))*100)

ggplot(data = env_sum, aes(x = environment, y = value, fill = pcent_value)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "#0F1B40") +
  geom_tile(colour = "white", size = 0.25) +
  labs(y = "Altitude", x = "Platform Operating Environment", fill = "% Selected") +
  theme(axis.text = element_text(colour = "black", size = rel(1.6), face = "bold"),
        axis.title = element_text(colour = "black", size = rel(1.8), face = "bold"),
        legend.title = element_text(face = "bold", size = rel(1.8)),
        legend.text = element_text(colour = "black", size = rel(1.6), face = "bold"),
        panel.background = element_rect( colour = "white", fill = "white"),
        panel.border = element_rect(colour = "black", fill = "transparent", size = 1),
        axis.line = element_line(colour = "black", size = 1))

```


Questions 22-34 Data Wrangling #DONE
```{r}
# Telemetry Attribute Importance Questions 22 - 34
attr<- telemetry_new %>%
  dplyr::select(line_office, mission_area, 41:53) %>%
  separate_rows(mission_area, sep = "; ") %>%
  mutate(across(everything(), ~ifelse(.=="","Not Applicable", as.character(.))))%>%
  pivot_longer(cols = starts_with("X"),
               names_to = "question",
               values_to = "rating") %>%
  mutate(rating = replace(rating, rating == "5 - highest value", 5)) %>%
  mutate(rating = replace(rating, rating == "1 - limited to no value", 1)) %>%
  mutate(rating = replace(rating, rating == "Not Applicable", 0)) %>%
  mutate(question = replace(question, question == "X22..PTT.durability...lifecycle", "PTT durability/lifecycle")) %>%
  mutate(question = replace(question, question == "X23..PTT.mass...size", "PTT mass/size")) %>%
  mutate(question = replace(question, question == "X24..PTT.power.management", "PTT power management")) %>%
  mutate(question = replace(question, question == "X25..Bandwidth.availability", "Bandwidth availability")) %>%
  mutate(question = replace(question, question == "X26..Two.way.commanding...communications", "Two-way commanding/communications")) %>% mutate(question = replace(question, question == "X27..PTT.immediate.send.on.platform.readiness", "PTT immediate send on platform readiness")) %>% mutate(question = replace(question, question == "X28..Minimal.time..latency..to.data.center", "Minimal time (latency) to data center")) %>%
  mutate(question = replace(question, question == "X29..Platform.position.accuracy", "Platform position accuracy")) %>%
  mutate(question = replace(question, question == "X30..Instrument.flexibility...extensibility", "Instrument flexibility & extensibility")) %>%
  mutate(question = replace(question, question == "X31..Platform.mobility", "Platform mobility")) %>%
  mutate(question = replace(question, question == "X32..Communications.Availability", "Communications availability")) %>%
  mutate(question = replace(question, question == "X33..Telemetry.contract.subscription.cost.predictability...stability", "Telemetry contract subscription cost predictability/stability")) %>%
  mutate(question = replace(question, question == "X34..Ability.to.seamlessly.change.telemetry.service.providers.for.deployed.platforms", "Ability to seamlessly change telemetry service providers for deployed platforms")) %>%
  mutate(rating = replace(rating, rating =="", 0))


attr_sum_MSA <- attr %>%
  group_by(mission_area, question, rating) %>%
  dplyr::summarize(count = n()) %>%
  as.data.frame() %>%
  mutate(rating_importance = as.numeric(rating)*count) %>%
  group_by(mission_area, question) %>%
  dplyr::summarize(question_importance = sum(rating_importance))%>%
  as.data.frame() %>%
  mutate(question_importance = as.numeric(question_importance))

attr_sum_LO <- attr %>%
  group_by(line_office, question, rating) %>%
  dplyr::summarize(count = n()) %>%
  as.data.frame() %>%
  dplyr::mutate(rating_importance = as.numeric(rating)*count) %>%
  group_by(line_office, question) %>%
  dplyr::summarize(question_importance = sum(rating_importance)) %>%
  as.data.frame() %>%
  dplyr::mutate(question_importance = as.numeric(question_importance)) 



attr_MSA_wide<-spread(attr_sum_MSA, mission_area, question_importance)
attr_LO_wide<-spread(attr_sum_LO, line_office, question_importance)

attr_LO_wide %>% mutate(sum = rowSums(across(where(is.numeric)))) %>% View()
```
## Q22-34: Heatmap by Mission Area #DONE
```{r}
attr_MSA_long <- attr_MSA_wide %>%
  as.data.frame() %>%
  pivot_longer(!question, names_to = "MSA", values_to="Importance")
attr_MSA_normalization<-attr_MSA_long %>%
  group_by(MSA) %>%
  dplyr::summarize(total_imp = sum(Importance))
attr_MSA_long <- attr_MSA_long %>%
  full_join(attr_MSA_normalization, by="MSA") %>%
  mutate(`% Importance` = (Importance/total_imp)*100)


attr_msa_heatmap <- ggplot(data = attr_MSA_long, aes(x = stringr::str_wrap(MSA,15), y = stringr::str_wrap(question, 31), fill = `% Importance`)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "#0F1B40") +
  geom_tile(colour = "white", size = 0.25) +
  labs(y = "Attribute", x = "Mission Area") +
  theme(axis.text = element_text(colour = "black", size = rel(1.2)),
        axis.title = element_text(colour = "black", size = rel(1.8), face = "bold"),
        legend.title = element_text(face = "bold", size = rel(1.8)),
        legend.text = element_text(colour = "black", size = rel(1.2)))
attr_msa_heatmap
```
## Q22-34: Heatmap by LO #DONE
```{r}
attr_LO_long <- attr_LO_wide %>%
  as.data.frame() %>%
  pivot_longer(!question, names_to = "LO", values_to="Importance")
attr_LO_normalization<-attr_LO_long %>%
  group_by(LO) %>%
  dplyr::summarize(total_imp = sum(Importance))
attr_LO_long <- attr_LO_long %>%
  full_join(attr_LO_normalization, by="LO") %>%
  mutate(`% Importance` = (Importance/total_imp)*100)


attr_lo_heatmap <- ggplot(data = attr_LO_long, aes(x = stringr::str_wrap(LO, 10), y = stringr::str_wrap(question, 31), fill = `% Importance`)) +
  geom_tile() +
# scale_fill_gradient(low = "white", high = "#048C8C") +
   scale_fill_gradient(low = "white", high = "#0F1B40") +
#  scale_fill_gradient(low = "white", high = "darkblue") + 
  geom_tile(colour = "white", size = 0.25) +
  labs(y = "Attribute", x = "Line Office") +
  theme(axis.text = element_text(colour = "black", size = rel(1.2)),
        axis.title = element_text(colour = "black", size = rel(1.8), face = "bold"),
        legend.title = element_text(face = "bold", size = rel(1.8)),
        legend.text = element_text(colour = "black", size = rel(1.2)))
attr_lo_heatmap
```


Questions 30, 33, 34 Data Wrangling #DONE
```{r}
# Telemetry Attribute Importance Questions 30, 33, 34
attr2<- telemetry_new %>%
  dplyr::select(line_office, mission_area, 49, 52, 53) %>%
  separate_rows(mission_area, sep = "; ") %>%
  mutate(across(everything(), ~ifelse(.=="","Not Applicable", as.character(.))))%>%
  pivot_longer(cols = starts_with("X"),
               names_to = "question",
               values_to = "rating") %>%
  mutate(rating = replace(rating, rating == "5 - highest value", 5)) %>%
  mutate(rating = replace(rating, rating == "1 - limited to no value", 1)) %>%
  mutate(rating = replace(rating, rating == "Not Applicable", 0)) %>%
  mutate(question = replace(question, question == "X30..Instrument.flexibility...extensibility", "Instrument flexibility & extensibility")) %>%
  mutate(question = replace(question, question == "X33..Telemetry.contract.subscription.cost.predictability...stability", "Telemetry contract subscription cost predictability/stability")) %>%
  mutate(question = replace(question, question == "X34..Ability.to.seamlessly.change.telemetry.service.providers.for.deployed.platforms", "Ability to seamlessly change telemetry service providers for deployed platforms")) %>%
  mutate(rating = replace(rating, rating =="", 0))


attr_sum_MSA2 <- attr2 %>%
  group_by(mission_area, question, rating) %>%
  dplyr::summarize(count = n()) %>%
  as.data.frame() %>%
  mutate(rating_importance = as.numeric(rating)*count) %>%
  group_by(mission_area, question) %>%
  dplyr::summarize(question_importance = sum(rating_importance))%>%
  as.data.frame() %>%
  mutate(question_importance = as.numeric(question_importance))

attr_sum_LO2 <- attr2 %>%
  group_by(line_office, question, rating) %>%
  dplyr::summarize(count = n()) %>%
  as.data.frame() %>%
  mutate(rating_importance = as.numeric(rating)*count) %>%
  group_by(line_office, question) %>%
  dplyr::summarize(question_importance = sum(rating_importance)) %>%
  as.data.frame() %>%
  mutate(question_importance = as.numeric(question_importance))



attr_MSA_wide2<-spread(attr_sum_MSA2, mission_area, question_importance)
attr_LO_wide2<-spread(attr_sum_LO2, line_office, question_importance)
```
## Questions 30, 33, 34: Heatmap by Mission Area
```{r}
attr_MSA_long2 <- attr_MSA_wide2 %>%
  as.data.frame() %>%
  pivot_longer(!question, names_to = "MSA", values_to="Importance")
attr_MSA_normalization2<-attr_MSA_long2 %>%
  group_by(MSA) %>%
  dplyr::summarize(total_imp = sum(Importance))
attr_MSA_long2 <- attr_MSA_long2 %>%
  full_join(attr_MSA_normalization2, by="MSA") %>%
  mutate(`% Importance` = (Importance/total_imp)*100)


attr_msa_heatmap2 <- ggplot(data = attr_MSA_long2, aes(x = stringr::str_wrap(MSA,15), y = stringr::str_wrap(question, 35), fill = `% Importance`)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "#0F1B40") +
  geom_tile(colour = "white", size = 0.25) +
  labs(y = "Attribute", x = "Mission Area") +
  theme(axis.text = element_text(colour = "black", size = rel(1.1)),
        axis.title = element_text(colour = "black", size = rel(1.2), face = "bold"),
        legend.title = element_text(face = "bold", size = rel(1.2)),
        legend.text = element_text(colour = "black", size = rel(1.1)))
attr_msa_heatmap2
```
## Questions 30, 33, 34: Heatmap by LO
```{r}
attr_LO_long2 <- attr_LO_wide2 %>%
  as.data.frame() %>%
  pivot_longer(!question, names_to = "LO", values_to="Importance")
attr_LO_normalization2<-attr_LO_long2 %>%
  group_by(LO) %>%
  dplyr::summarize(total_imp = sum(Importance))
attr_LO_long2 <- attr_LO_long2 %>%
  full_join(attr_LO_normalization2, by="LO") %>%
  mutate(`% Importance` = (Importance/total_imp)*100)


attr_lo_heatmap2 <- ggplot(data = attr_LO_long2, aes(x = stringr::str_wrap(LO, 6), y = stringr::str_wrap(question, 35), fill = `% Importance`)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "#0F1B40") +
  geom_tile(colour = "white", size = 0.25) +
  labs(y = "Attribute", x = "Line Office") +
  theme(axis.text = element_text(colour = "black", size = rel(1.1)),
        axis.title = element_text(colour = "black", size = rel(1.2), face = "bold"),
        legend.title = element_text(face = "bold", size = rel(1.2)),
        legend.text = element_text(colour = "black", size = rel(1.1)))
attr_lo_heatmap2
```


Questions 36, 37, 38, 40
```{r}
# Telremetry Attribute Importance Questions 36, 37, 38, 40
post_2027<- telemetry_new %>%
  dplyr::select(line_office, mission_area, 55, 56, 57, 59) %>%
  separate_rows(mission_area, sep = "; ")

####Provider Plans by MSA####
provider_plans_msa <- post_2027 %>%
  separate_rows(X36..What.statement.best.characterizes.your.program.s.future...post.2027..plans.for.telemetry.service.provider.s., sep = ";") %>%
  dplyr::rename(provider = X36..What.statement.best.characterizes.your.program.s.future...post.2027..plans.for.telemetry.service.provider.s.) %>%
  mutate(provider = replace(provider, provider == "Don't know which telemetry provider our program will use", "Don't know")) %>%
  mutate(provider = replace(provider, provider == "Multiple telemetry providers to manage budget predictability and accessibility risk", "Multiple providers")) %>%
  group_by(mission_area, provider) %>%
  summarize(provider_count = n()) %>%
  as.data.frame()

provider_plans_msa$provider <- factor(provider_plans_msa$provider, levels = c("Satellite - Iridium","Satellite - GOES DCP (GEO)","Satellite - CNES/CLS/Kineis system (LEO)","Satellite - Other","Terrestrial - Other (RF, Cell, Internet)", "Multiple providers", "Don't know"))


provider_msa<-ggplot(provider_plans_msa, aes(fill = stringr::str_wrap(mission_area,40), y = provider_count, x = reorder(stringr::str_wrap(provider,15), provider_count))) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values = my_palette_msa) +
 theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.4)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.24, 0.885)) +
  labs(x = "Provider", y = "Count", fill = "Mission Area") +
  scale_y_continuous(limits = c(0, 40), expand = c(0.01,0))
provider_msa


#ggballoonplot(provider_plans_msa, x = "provider", y = "mission_area", fill = "mission_area") + scale_fill_viridis_d(option = "C")

####Provider Count Inclusion####
#pro_count <- post_2027 %>%
#  separate_rows(X36..What.statement.best.characterizes.your.program.s.future...post.2027..plans.for.telemetry.service.provider.s., sep = ";") %>%
#  rename(provider = X36..What.statement.best.characterizes.your.program.s.future...post.2027..plans.for.telemetry.service.provider.s.) %>%
#  mutate(provider = replace(provider, provider == "Don't know which telemetry provider our program will use", "Don't know")) %>%
#    mutate(provider = replace(provider, provider == "Multiple telemetry providers to manage budget predictability and accessibility risk", "Multiple providers")) %>%
#  group_by(provider) %>%
#  summarize(provider_all_count = n()) %>%
#  as.data.frame()


####Provider Plans by LO####
provider_plans_lo <- post_2027 %>%
  separate_rows(X36..What.statement.best.characterizes.your.program.s.future...post.2027..plans.for.telemetry.service.provider.s., sep = ";") %>%
  dplyr::rename(provider = X36..What.statement.best.characterizes.your.program.s.future...post.2027..plans.for.telemetry.service.provider.s.) %>%
  mutate(provider = replace(provider, provider == "Don't know which telemetry provider our program will use", "Don't know")) %>%
    mutate(provider = replace(provider, provider == "Multiple telemetry providers to manage budget predictability and accessibility risk", "Multiple providers")) %>%
  group_by(line_office, provider) %>%
  summarize(provider_count = n()) %>%
  as.data.frame() %>%
  drop_na()
provider_plans_lo$provider<-factor(provider_plans_lo$provider, levels = c("Satellite - Iridium","Satellite - GOES DCP (GEO)","Satellite - CNES/CLS/Kineis system (LEO)","Satellite - Other", "Terrestrial - Other (RF, Cell, Internet)", "Multiple providers", "Don't know"))

#provider_lo<-ggplot(provider_plans_lo, aes(fill = line_office, y = provider_count, x = reorder( stringr::str_wrap(provider, 15),provider_all_count))) +
#  geom_bar(position = "stack", stat = "identity") +
#  scale_fill_manual(values = c("#0D8F81", "#6EC574", "#39AB7E", "#A9DC67", "#EDEF5D")) +
# theme_classic() +
#  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
#        axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
#        axis.line = element_line(size = 1),
#        legend.title = element_text(face = "bold", size = rel(1.4)),
#        legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
#        legend.key.size = unit(1.2,'lines'),
#        legend.position = c(0.16, 0.86)) +
#  labs(x = "Provider", y = "Count", fill = "Line Office")
#provider_lo

ggballoonplot(provider_plans_lo, x= "provider", y = "line_office", fill = "line_office") + scale_fill_viridis_d(option = "C")

####Future Number Platforms####
future_number_msa <- post_2027 %>%
  dplyr::rename(number_future_platforms = X37..In.2027.and.beyond..my.program.will.likely.require..pick.response..number.of.telemetry.subscriptions...platforms) %>%
  mutate(number_future_platforms = replace(number_future_platforms, number_future_platforms =="Don't know how our program needs for telemetry subscriptions will change", "Don't know")) %>%
  mutate(number_future_platforms = replace(number_future_platforms, number_future_platforms =="more than 20% than current", ">20%")) %>%
  mutate(number_future_platforms = replace(number_future_platforms, number_future_platforms =="less than 20% than current", "<20%")) %>%
  group_by(mission_area, number_future_platforms) %>%
  summarize(platforms_count = n()) %>%
  as.data.frame()


treemap(future_number_msa,
        index = c("number_future_platforms","mission_area"),
        vSize = "platforms_count",
        type = "index",
        bg.labels =c("transparent"),
        fontsize.labels = c(18, 14),
        fontcolor.labels = c("white","black"),
        align.labels = list(
          c("right","top"),
          c("left","bottom")),
        border.lwds = c(5,2),
        palette = terrain.colors(4),
        title = "Number of Telemetry Subscriptions in 2027 and Beyond")

#future_number_msa<-ggplot(future_number_msa, aes(fill = stringr::str_wrap(mission_area,40), y = platforms_count, x = number_future_platforms)) +
#  geom_bar(position = "stack", stat = "identity") +
#  scale_fill_manual(values = c("#0D8F81", "#39AB7E", "#A9DC67", "#EDEF5D")) +
# theme_classic() +
#  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
#        axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
#        axis.line = element_line(size = 1),
#        legend.title = element_text(face = "bold", size = rel(1.4)),
#        legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
#        legend.key.size = unit(1.2,'lines'),
#        legend.position = c(0.22, 0.86)) +
#  labs(x = "Platforms", y = "Count", fill = "Mission Area")
#future_number_msa


future_number_lo <- post_2027 %>%
  dplyr::rename(number_future_platforms = X37..In.2027.and.beyond..my.program.will.likely.require..pick.response..number.of.telemetry.subscriptions...platforms) %>%
  mutate(number_future_platforms = replace(number_future_platforms, number_future_platforms =="Don't know how our program needs for telemetry subscriptions will change", "Don't know")) %>%
  mutate(number_future_platforms = replace(number_future_platforms, number_future_platforms =="more than 20% than current", ">20%")) %>%
  mutate(number_future_platforms = replace(number_future_platforms, number_future_platforms =="less than 20% than current", "<20%")) %>%
  group_by(line_office, number_future_platforms) %>%
  summarize(platforms_count = n()) %>%
  as.data.frame()


treemap(future_number_lo,
        index = c("number_future_platforms","line_office"),
        vSize = "platforms_count",
        type = "index",
        bg.labels =c("transparent"),
        fontsize.labels = c(18, 14),
        fontcolor.labels = c("white","black"),
        align.labels = list(
          c("right","top"),
          c("left","bottom")
        ),
        border.lwds = c(5,2),
        palette = terrain.colors(4),
        title = "Number of Telemetry Subscriptions in 2027 and Beyond")

####Future Bandwidth####
future_bandwidth_msa <- post_2027 %>%
  dplyr::rename(future_bandwidth = X38..In.2027.and.beyond..my.program.s.telemetry.bandwidth.requirements.per.platform.will.be.....) %>%
  mutate(future_bandwidth = replace(future_bandwidth, future_bandwidth =="Don't know how our program needs for bandwidth will change", "Don't know")) %>%
  mutate(future_bandwidth = replace(future_bandwidth, future_bandwidth =="more than 20% than current", ">20%")) %>%
  mutate(future_bandwidth = replace(future_bandwidth, future_bandwidth =="less than 20% then current", "<20%")) %>%
  group_by(mission_area, future_bandwidth) %>%
  summarize(bandwidth_count = n()) %>%
  as.data.frame()

treemap(future_bandwidth_msa,
        index = c("future_bandwidth","mission_area"),
        vSize = "bandwidth_count",
        type = "index",
        bg.labels =c("transparent"),
        fontsize.labels = c(18, 14),
        fontcolor.labels = c("white","black"),
        align.labels = list(
          c("right","top"),
          c("left","bottom")
        ),
        border.lwds = c(5,2),
        lowerbound.cex.labels = 1,
        palette = terrain.colors(4),
        title = "Bandwidth Requirements in 2027 and Beyond")

future_bandwidth_lo <- post_2027 %>%
  dplyr::rename(future_bandwidth = X38..In.2027.and.beyond..my.program.s.telemetry.bandwidth.requirements.per.platform.will.be.....) %>%
  mutate(future_bandwidth = replace(future_bandwidth, future_bandwidth =="Don't know how our program needs for bandwidth will change", "Don't know")) %>%
  mutate(future_bandwidth = replace(future_bandwidth, future_bandwidth =="more than 20% than current", ">20%")) %>%
  mutate(future_bandwidth = replace(future_bandwidth, future_bandwidth =="less than 20% then current", "<20%")) %>%
  group_by(line_office, future_bandwidth) %>%
  summarize(bandwidth_count = n()) %>%
  as.data.frame()

treemap(future_bandwidth_lo,
        index = c("future_bandwidth","line_office"),
        vSize = "bandwidth_count",
        type = "index",
        bg.labels =c("transparent"),
        fontsize.labels = c(18, 14),
        fontcolor.labels = c("white","black"),
        align.labels = list(
          c("right","top"),
          c("left","bottom")
        ),
        border.lwds = c(5,2),
        palette = terrain.colors(4),
        title = "Bandwidth Requirements in 2027 and Beyond")
```


11a Spatial Domain
```{r}
spatial_domain<-telemetry_new %>%
  dplyr::select(line_office, mission_area, X11.a.Required.Operating.Spatial.Domain..pick.one.) %>%
  dplyr::rename(geo_cov = X11.a.Required.Operating.Spatial.Domain..pick.one.) %>%
  filter(geo_cov != "")

spatial_domain_msa <- spatial_domain %>%
  dplyr::select(-line_office) %>%
  separate_rows(mission_area, sep = "; ") %>%
  group_by(mission_area, geo_cov) %>%
  summarize(geo_count = n()) %>%
  as.data.frame()

ggplot(spatial_domain_msa, aes(x = reorder(geo_cov, geo_count), y = geo_count, fill = stringr::str_wrap(mission_area,50))) +
   geom_bar(position = "stack", stat = "identity") +
   theme_classic() +
   theme(axis.title = element_text(face = "bold", size = rel(1.4)),
         axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
         axis.line = element_line(size = 1),
         legend.title = element_text(face = "bold", size = rel(1.4)),
         legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
         legend.position = c(0.22, 0.9)) +
  labs(x = "Spatial Domain", y = "Count", fill = "Mission Area") + scale_fill_manual(values = my_palette_msa)

spatial_domain_lo <- spatial_domain %>%
  select(-mission_area) %>%
  group_by(line_office, geo_cov) %>%
  summarize(geo_count=n()) %>%
  as.data.frame()

ggplot(spatial_domain_lo, aes(x = reorder(geo_cov, geo_count), y=geo_count, fill=line_office)) +
   geom_bar(position = "stack", stat = "identity") +
   theme_classic() +
   theme(axis.title = element_text(face = "bold", size = rel(1.4)),
         axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
         axis.line = element_line(size = 1),
         legend.title = element_text(face = "bold", size = rel(1.4)),
         legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
         legend.position = c(0.16, 0.89)) +
  labs(x = "Spatial Domain", y = "Count", fill = "Line Office") + scale_fill_brewer(palette = "Set2")
```

Q12 Platform Mobility #DONE
```{r}
pltfrm_mobility<-telemetry_new %>%
  dplyr::select(line_office, mission_area, X12..Indicate.platform.mobility) %>%
  dplyr::rename(mobility = X12..Indicate.platform.mobility) %>%
  filter(mobility != "") %>% 
  separate_rows(mobility, sep = ";")

pltfrm_mobility_msa <- pltfrm_mobility %>%
  dplyr::select(-line_office) %>%
  separate_rows(mission_area, sep = "; ") %>%
  group_by(mission_area, mobility) %>%
  summarize(mobility_count = n()) %>%
  as.data.frame()

ggplot(pltfrm_mobility_msa, aes(x = reorder(stringr::str_wrap(mobility,20), mobility_count), y = mobility_count, fill = stringr::str_wrap(mission_area, 36))) +
   geom_bar(position = "stack", stat = "identity") +
   theme_classic() +
   scale_y_continuous(limits = c(0, 40), expand = c(0.01,0)) +
   theme(axis.title = element_text(face = "bold", size = rel(1.8)),
         axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
         axis.line = element_line(size = 1),
         legend.title = element_text(face = "bold", size = rel(1.6)),
         legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
         legend.position = c(0.245, 0.87)) +
  labs(x = "Platform Mobility", y = "Count", fill = "Mission Area") + 
  scale_fill_manual(values = my_palette_msa)


pltfrm_mobility_lo <- pltfrm_mobility %>%
  select(-mission_area) %>%
  group_by(line_office, mobility) %>%
  summarize(mobility_count=n()) %>%
  as.data.frame()

ggplot(pltfrm_mobility_lo, aes(x = reorder(stringr::str_wrap(mobility, 20), mobility_count), y=mobility_count, fill=line_office)) +
   geom_bar(position = "stack", stat = "identity") +
   theme_classic() +
   scale_y_continuous(limits = c(0, 30), expand = c(0.01,0)) +
   theme(axis.title = element_text(face = "bold", size = rel(1.8)),
         axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
         axis.line = element_line(size = 1),
         legend.title = element_text(face = "bold", size = rel(1.6)),
         legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
         legend.position = c(0.205, 0.88)) +
  labs(x = "Platform Mobility", y = "Count", fill = "Line Office") + 
  scale_fill_manual(values = my_palette_lo)
```


Q8b(hor & vert), 8c, 13, 14, 16, 19, 20
% Satisfied Utility Curves
```{r}
utility<- telemetry_new %>%
  select(line_office, mission_area, 13, 14, 15, 30, 31, 32, 33, 34, 35, 37, 38, 39, 40) %>%
  mutate_all(na_if, "") %>%
  mutate_all(na_if, "Not applicable") %>%
  mutate_all(na_if, "not applicable") %>%
  mutate_all(na_if, "Don't know")


####8b Utility Position Accuracy: Horizontal####
position_hor_all<- utility %>%
  dplyr::select(line_office, mission_area, X8.b.If.position.is.required..indicate.required.accuracy..horizontal.) %>%
  separate_rows(X8.b.If.position.is.required..indicate.required.accuracy..horizontal., sep = ";") %>%
  dplyr::rename(position_accuracy_horizontal = X8.b.If.position.is.required..indicate.required.accuracy..horizontal.) %>%
  mutate(position_accuracy_horizontal = as.factor(position_accuracy_horizontal)) %>% 
  na.omit() %>%
  group_by(position_accuracy_horizontal) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  mutate(position_accuracy_horizontal = ordered(position_accuracy_horizontal, levels = c("0.1-1.0m","1-10m","10-50m","50-100m","100-200m","200-4000m"))) %>%
  arrange(position_accuracy_horizontal) %>%
  dplyr::summarize(mission_area = "All",
         line_office = "All",
         position_accuracy_horizontal = position_accuracy_horizontal,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100)

#By MSA
position_hor_MSA<- utility %>%
  dplyr::select(line_office, mission_area, X8.b.If.position.is.required..indicate.required.accuracy..horizontal.) %>%
  dplyr::rename(position_accuracy_horizontal = X8.b.If.position.is.required..indicate.required.accuracy..horizontal.) %>%
  separate_rows(mission_area, sep = "; ") %>% 
  separate_rows(position_accuracy_horizontal, sep = ";") %>%
  mutate(position_accuracy_horizontal = as.factor(position_accuracy_horizontal)) %>%
  na.omit() %>%
  group_by(mission_area, position_accuracy_horizontal) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  mutate(position_accuracy_horizontal = ordered(position_accuracy_horizontal, levels = c("0.1-1.0m","1-10m","10-50m","50-100m","100-200m","200-4000m"))) %>%
  arrange(position_accuracy_horizontal) %>%
  group_by(mission_area) %>%
  dplyr::summarize(position_accuracy_horizontal = position_accuracy_horizontal,
            cum_count = cumsum(survey_count),
            cum_diff = cum_count - survey_count,
            max = max(cum_count),
            accumulated = max - cum_diff,
            `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()


position_hor_all_msa <- position_hor_all %>% select(-line_office)
position_hor_MSA<-rbind(position_hor_MSA, position_hor_all_msa)
position_hor_MSA<-position_hor_MSA %>%
  group_by(mission_area) %>% mutate(lo_count = n()) %>% filter(lo_count>1)

# need to create a palette that involves one more color for all!
position_hor_MSA %>%
  ggplot(aes(x = position_accuracy_horizontal, y = `% Satisfied`, group = mission_area, color = mission_area, linetype = mission_area)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = my_palette_msa_utility, labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.28, 0.87)) +
  geom_hline(yintercept = 50, linetype = "dotted")+ scale_x_discrete(limits = rev) + 
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) +
  guides(linetype = FALSE, color = guide_legend(title = "Mission Area")) +
  labs(x = "Horizontal Position Accuracy")


#By LO
position_hor_LO<- utility %>%
  select(line_office, mission_area, X8.b.If.position.is.required..indicate.required.accuracy..horizontal.) %>%
  dplyr::rename(position_accuracy_horizontal = X8.b.If.position.is.required..indicate.required.accuracy..horizontal.) %>%
  separate_rows(position_accuracy_horizontal, sep = ";") %>%
  mutate(position_accuracy_horizontal = as.factor(position_accuracy_horizontal)) %>% 
  na.omit() %>%
  group_by(line_office, position_accuracy_horizontal) %>%
  dplyr::summarize(survey_count = n()) %>% 
  as.data.frame()%>%
  mutate(position_accuracy_horizontal = ordered(position_accuracy_horizontal, levels = c("0.1-1.0m","1-10m","10-50m","50-100m","100-200m","200-4000m"))) %>%
  arrange(position_accuracy_horizontal) %>%
  group_by(line_office) %>%
  dplyr::summarize(position_accuracy_horizontal = position_accuracy_horizontal,
            cum_count = cumsum(survey_count),
            cum_diff = cum_count - survey_count,
            max = max(cum_count),
            accumulated = max - cum_diff,
            `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
position_hor_all_lo <- position_hor_all %>% select(-mission_area)
position_hor_LO<-rbind(position_hor_LO, position_hor_all_lo)
position_hor_LO<-position_hor_LO %>%
  group_by(line_office) %>% mutate(lo_count = n()) %>% filter(lo_count>1)


position_hor_LO %>%
  ggplot(aes(x = position_accuracy_horizontal, y = `% Satisfied`, group = line_office, color = line_office, linetype = line_office)) + 
  geom_line(size = 1.2)+
  geom_hline(yintercept = 50, linetype = "dotted")+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid","solid"))+
  scale_color_manual(values = my_palette_lo_utility, labels = function(x) str_wrap(x, width = 35)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1,'lines'),
        legend.position = c(0.2, 0.90)) +
  scale_x_discrete(limits = rev) + 
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + 
  guides(linetype = FALSE, color = guide_legend(title = "Line Office")) +
  labs(x = "Horizontal Position Accuracy")


####8b Utility Position Accuracy: Vertical####
position_vert_all<- utility %>%
  select(line_office, mission_area, X8.b.If.position.is.required..indicate.required.accuracy..vertical.) %>%
  separate_rows(X8.b.If.position.is.required..indicate.required.accuracy..vertical., sep = ";") %>%
  dplyr::rename(position_accuracy_vertical = X8.b.If.position.is.required..indicate.required.accuracy..vertical.) %>%
  separate_rows(position_accuracy_vertical, sep = ";") %>%
  mutate(position_accuracy_vertical = as.factor(position_accuracy_vertical)) %>%
  na.omit() %>%
  group_by(position_accuracy_vertical) %>%
  dplyr::summarize(survey_count = n()) %>%
  as.data.frame()%>%
  mutate(position_accuracy_vertical = ordered(position_accuracy_vertical, levels = c("0.1-1.0m","1-10m","10-50m","50-100m","100-200m","200-4000m"))) %>%
  arrange(position_accuracy_vertical) %>%
  dplyr::summarize(mission_area = "All",
         line_office = "All",
         position_accuracy_vertical = position_accuracy_vertical,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

#By MSA
position_vert_MSA<- utility %>%
  select(line_office, mission_area, X8.b.If.position.is.required..indicate.required.accuracy..vertical.) %>%
  separate_rows(mission_area, sep = "; ") %>%
  dplyr::rename(position_accuracy_vertical = X8.b.If.position.is.required..indicate.required.accuracy..vertical.) %>%
  separate_rows(position_accuracy_vertical, sep = ";") %>%
  mutate(position_accuracy_vertical = as.factor(position_accuracy_vertical)) %>%
  na.omit() %>%
  group_by(mission_area, position_accuracy_vertical) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  mutate(position_accuracy_vertical = ordered(position_accuracy_vertical, levels = c("0.1-1.0m","1-10m","10-50m","50-100m","100-200m","200-4000m"))) %>%
  arrange(position_accuracy_vertical) %>%
  group_by(mission_area) %>%
  dplyr::summarize(position_accuracy_vertical = position_accuracy_vertical,
            cum_count = cumsum(survey_count),
            cum_diff = cum_count - survey_count,
            max = max(cum_count),
            accumulated = max - cum_diff,
            `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

position_vert_all_msa <- position_vert_all %>% select(-line_office)
position_vert_MSA<-rbind(position_vert_MSA, position_vert_all_msa)
position_vert_MSA<-position_vert_MSA %>%
  group_by(mission_area) %>% mutate(ma_count = n()) %>% filter(ma_count>1)

position_vert_MSA %>%
  ggplot(aes(x = position_accuracy_vertical, y = `% Satisfied`, group = mission_area, color = mission_area, linetype = mission_area)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = my_palette_msa_utility, labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.27, 0.865)) +
  scale_x_discrete(limits = rev) + 
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) +
  geom_hline(yintercept = 50, linetype = "dotted")+
  guides(linetype = FALSE, color = guide_legend(title = "Mission Area")) +
  labs(x = "Vertical Position Accuracy")


#By LO
position_vert_LO<- utility %>%
  select(line_office, mission_area, X8.b.If.position.is.required..indicate.required.accuracy..vertical.) %>%
  dplyr::rename(position_accuracy_vertical = X8.b.If.position.is.required..indicate.required.accuracy..vertical.) %>%
  separate_rows(position_accuracy_vertical, sep = ";") %>%
  mutate(position_accuracy_vertical = as.factor(position_accuracy_vertical)) %>%
  na.omit() %>%
  group_by(line_office, position_accuracy_vertical) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  mutate(position_accuracy_vertical = ordered(position_accuracy_vertical, levels = c("0.1-1.0m","1-10m","10-50m","50-100m","100-200m","200-4000m"))) %>%
  arrange(position_accuracy_vertical) %>%
  group_by(line_office) %>%
  dplyr::summarize(position_accuracy_vertical = position_accuracy_vertical,
            cum_count = cumsum(survey_count),
            cum_diff = cum_count - survey_count,
            max = max(cum_count),
            accumulated = max - cum_diff,
            `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

position_vert_all_lo <- position_vert_all %>% select(-mission_area)
position_vert_LO<-rbind(position_vert_LO, position_vert_all_lo)
position_vert_LO<-position_vert_LO %>%
  group_by(line_office) %>% mutate(lo_count = n()) %>% filter(lo_count>1)

position_vert_LO %>%
  ggplot(aes(x = position_accuracy_vertical, y = `% Satisfied`, group = line_office, color = line_office, linetype = line_office)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid","solid"))+
  scale_color_manual(values = my_palette_lo_utility, labels = function(x) str_wrap(x, width = 35)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1,'lines'),
        legend.position = c(0.2, 0.905)) +
  scale_x_discrete(limits = rev) + 
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + 
  guides(linetype = FALSE, color = guide_legend(title = "Line Office")) +
  labs(x = "Vertical Position Accuracy")



####8c Max time to determine position####
position_max_all<- utility %>%
  select(line_office, mission_area, X8.c.If.position.required..what.is.the.maximum.time.to.determine.position.required.) %>%
  dplyr::rename(position_max_time = X8.c.If.position.required..what.is.the.maximum.time.to.determine.position.required.) %>%
  separate_rows(position_max_time, sep = ";") %>%
  mutate(position_max_time = replace(position_max_time, position_max_time =="greater than 75 seconds permissible", "75+ seconds")) %>%
  mutate(position_max_time = as.factor(position_max_time)) %>%
  na.omit() %>%
  group_by(position_max_time) %>%
  dplyr::summarize(survey_count = n()) %>%
  as.data.frame()%>%
#  add_row(position_max_time = "10-75 seconds", survey_count = 0) %>%
  mutate(position_max_time = ordered(position_max_time, levels = c("1 second","1-3 seconds","3-10 seconds","10-75 seconds", "75+ seconds"))) %>%
  arrange(position_max_time) %>%
  dplyr::summarize(mission_area = "All",
         line_office = "All",
         position_max_time = position_max_time,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

#MSA
position_max_MSA<- utility %>%
  select(mission_area, X8.c.If.position.required..what.is.the.maximum.time.to.determine.position.required.) %>%
  separate_rows(mission_area, sep = "; ") %>%
  dplyr::rename(position_max_time = X8.c.If.position.required..what.is.the.maximum.time.to.determine.position.required.) %>%
  mutate(position_max_time = replace(position_max_time, position_max_time =="greater than 75 seconds permissible", "75+ seconds")) %>%
  separate_rows(position_max_time, sep = ";") %>%
  mutate(position_max_time = as.factor(position_max_time)) %>%
  na.omit() %>%
  group_by(mission_area, position_max_time) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
#  add_row(mission_area = "Buoy Tracking, Vessel Tracking, and Data Applications", position_max_time = "10-75 seconds", survey_count = 0) %>% 	
  add_row(mission_area = "Buoy Tracking, Vessel Tracking, and Data Applications", position_max_time = "1 second", survey_count = 0) %>%
#  add_row(mission_area = "Meteorology and Climatology", position_max_time = "10-75 seconds", survey_count = 0) %>% 	
#  add_row(mission_area = "Oceanography, Hydrography, Pollution/Water Quality, and Sea Ice", position_max_time = "10-75 seconds", survey_count = 0) %>%
#  add_row(mission_area = "Wildlife Tracking", position_max_time = "10-75 seconds", survey_count = 0) %>% 
  mutate(position_max_time = ordered(position_max_time, levels = c("1 second","1-3 seconds","3-10 seconds","10-75 seconds","75+ seconds"))) %>%
  arrange(position_max_time) %>%
  group_by(mission_area) %>%
  dplyr::summarize(position_max_time = position_max_time,
            cum_count = cumsum(survey_count),
            cum_diff = cum_count - survey_count,
            max = max(cum_count),
            accumulated = max - cum_diff,
            `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
position_max_all_msa <- position_max_all %>% select(-line_office)
position_max_MSA<-rbind(position_max_MSA, position_max_all_msa)
position_max_MSA<-position_max_MSA %>%
  group_by(mission_area) %>% mutate(ma_count = n()) %>% filter(ma_count>1)

position_max_MSA %>%
  ggplot(aes(x = position_max_time, y = `% Satisfied`, group = mission_area, color = mission_area, linetype = mission_area)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = my_palette_msa_utility, labels = function(x) str_wrap(x, width = 36))+
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.77, 0.17)) +
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + 
  geom_hline(yintercept = 50, linetype = "dotted") + 
  scale_x_discrete(limits = rev(levels(position_max_MSA$position_max_time))) +
  guides(linetype = FALSE, color = guide_legend(title = "Mission Area")) +
  labs(x = "Maximum Time to Determine Position")

#LO
position_max_lo<- utility %>%
  separate_rows(mission_area, sep = "; ") %>%
  select(line_office, X8.c.If.position.required..what.is.the.maximum.time.to.determine.position.required.) %>%
  dplyr::rename(position_max_time = X8.c.If.position.required..what.is.the.maximum.time.to.determine.position.required.) %>%
  mutate(position_max_time = replace(position_max_time, position_max_time =="greater than 75 seconds permissible", "75+ seconds")) %>%
  separate_rows(position_max_time, sep = ";") %>%
  mutate(position_max_time = as.factor(position_max_time)) %>%
  na.omit() %>%
  group_by(line_office, position_max_time) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame() %>%
#  add_row(line_office = "NMFS", position_max_time = "10-75 seconds", survey_count = 0) %>% 	
#  add_row(line_office = "NOS", position_max_time = "10-75 seconds", survey_count = 0) %>%
  add_row(line_office = "NOS", position_max_time = "1 second", survey_count = 0) %>%
#  add_row(line_office = "OAR & Non-NOAA (research)", position_max_time = "10-75 seconds", survey_count = 0) %>% 	
#  add_row(line_office= "OMAO & NESDIS", position_max_time = "10-75 seconds", survey_count = 0) %>%
  add_row(line_office= "OMAO & NESDIS", position_max_time = "1 second", survey_count = 0) %>%
  mutate(position_max_time = ordered(position_max_time, levels = c("1 second","1-3 seconds","3-10 seconds","10-75 seconds","75+ seconds"))) %>%
  arrange(position_max_time) %>%
  group_by(line_office) %>%
  dplyr::summarize(position_max_time = position_max_time,
            cum_count = cumsum(survey_count),
            cum_diff = cum_count - survey_count,
            max = max(cum_count),
            accumulated = max - cum_diff,
            `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

position_max_all_lo <- position_max_all %>% select(-mission_area)
position_max_lo<-rbind(position_max_lo, position_max_all_lo)
position_max_lo<-position_max_lo %>%
  group_by(line_office) %>% mutate(lo_count = n()) %>% filter(lo_count>1)

position_max_lo %>%
  ggplot(aes(x = position_max_time, y = `% Satisfied`, group = line_office, color = line_office, linetype = line_office)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = my_palette_lo_utility, labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.81, 0.15)) +
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + geom_hline(yintercept = 50, linetype = "dotted")+scale_x_discrete(limits = rev(levels(position_max_lo$position_max_time))) +
  guides(linetype = FALSE, color = guide_legend(title = "Line Office")) +
  labs(x = "Maximum Time to Determine Position")

#### Lifecycle Operation Duration ####
ops_duration_all<- utility %>%
  select(line_office, mission_area, X13..Indicate.Required.Platform.Lifecycle..operating.duration.) %>%
  dplyr::rename(ops_duration = X13..Indicate.Required.Platform.Lifecycle..operating.duration.) %>%
  separate_rows(ops_duration, sep = ";") %>%
  mutate(ops_duration = as.factor(ops_duration)) %>% 
  na.omit() %>%
  group_by(ops_duration) %>%
  dplyr::summarize(survey_count = n()) %>%
  as.data.frame()%>%
  mutate(ops_duration = ordered(ops_duration, levels = c("Variable","3 days","1 month","3 months","6 months","1 year","2 years","4 years",">4 years"))) %>%
  arrange(ops_duration) %>%
  dplyr::summarize(mission_area = "All",
         line_office = "All",
         ops_duration = ops_duration,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

# MSA
ops_duration_MSA<- utility %>%
  select(line_office, mission_area, X13..Indicate.Required.Platform.Lifecycle..operating.duration.) %>%
  dplyr::rename(ops_duration = X13..Indicate.Required.Platform.Lifecycle..operating.duration.) %>%
  separate_rows(ops_duration, sep = ";") %>%
  separate_rows(mission_area, sep = "; ") %>%
  mutate(ops_duration = as.factor(ops_duration)) %>% na.omit() %>%
  group_by(mission_area, ops_duration) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame() %>%
  mutate(ops_duration = ordered(ops_duration, levels = c("Variable","3 days","1 month","3 months","6 months","1 year","2 years","4 years",">4 years"))) %>%
  arrange(ops_duration) %>%
  group_by(mission_area) %>%
  dplyr::summarize(ops_duration = ops_duration,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

ops_duration_all_msa <- ops_duration_all %>% select(-line_office)
ops_duration_MSA<-rbind(ops_duration_MSA, ops_duration_all_msa)
ops_duration_MSA<-ops_duration_MSA %>%
  group_by(mission_area) %>% mutate(lo_count = n()) %>% filter(lo_count>1)

ops_duration_MSA %>%
  ggplot(aes(x = ops_duration, y = `% Satisfied`, group = mission_area, color = mission_area, linetype = mission_area)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = my_palette_msa_utility, labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.5)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.74, 0.16)) +
  scale_x_discrete(limits = rev) + 
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + 
  geom_hline(yintercept = 50, linetype = "dotted")+
  guides(linetype = FALSE, color = guide_legend(title = "Mission Area")) +
  labs(x = "Lifecycle Operating Duration")

# LO
ops_duration_LO<- utility %>%
  select(line_office, mission_area, X13..Indicate.Required.Platform.Lifecycle..operating.duration.) %>%
  dplyr::rename(ops_duration = X13..Indicate.Required.Platform.Lifecycle..operating.duration.) %>%
  separate_rows(ops_duration, sep = ";") %>%
  mutate(ops_duration = as.factor(ops_duration)) %>%na.omit() %>%
  group_by(line_office, ops_duration) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame() %>%
  add_row(line_office = "OAR & Non-NOAA (research)", ops_duration = "Variable", survey_count = 0) %>%
  add_row(line_office = "NOS", ops_duration = "Variable", survey_count = 0) %>%
  add_row(line_office = "NWS", ops_duration = "Variable", survey_count = 0) %>%
  mutate(ops_duration = ordered(ops_duration, levels = c("Variable","3 days","1 month","3 months","6 months","1 year","2 years","4 years",">4 years"))) %>%
  arrange(ops_duration) %>%
  group_by(line_office) %>%
  dplyr::summarize(ops_duration = ops_duration,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

ops_duration_all_lo <- ops_duration_all %>% select(-mission_area)
ops_duration_LO<-rbind(ops_duration_LO, ops_duration_all_lo)
ops_duration_LO<-ops_duration_LO %>%
  group_by(line_office) %>% mutate(lo_count = n()) %>% filter(lo_count>1)

ops_duration_LO %>%
  ggplot(aes(x = ops_duration, y = `% Satisfied`, group = line_office, color = line_office, linetype = line_office)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid","solid"))+
  scale_color_manual(values = my_palette_lo_utility, labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.5)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.82, 0.13)) +
  scale_x_discrete(limits = rev) + 
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + 
  geom_hline(yintercept = 50, linetype = "dotted") +
  guides(linetype = FALSE, color = guide_legend(title = "Line Office")) +
  labs(x = "Lifecycle Operating Duration")

#### Power Consumption ####
power_use_all<- utility %>%
  select(line_office, mission_area, X14..Indicate.Requirement.for.Platform.Transmitting.Terminal..PTT..Power.Consumption..Watts.) %>%
  dplyr::rename(power_use = X14..Indicate.Requirement.for.Platform.Transmitting.Terminal..PTT..Power.Consumption..Watts.) %>%
  separate_rows(power_use, sep = ";") %>%
  mutate(power_use = as.factor(power_use)) %>% na.omit() %>%
  group_by(power_use) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  mutate(power_use = ordered(power_use, levels = c("5-20 Watts","2-5 Watts","1-2 Watts","0.1-1 Watt"))) %>%
  arrange(power_use) %>%
  dplyr::summarize(mission_area = "All",
         line_office = "All",
         power_use = power_use,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>%
  as.data.frame()


# MSA
power_use_MSA<- utility %>%
 select(line_office, mission_area, X14..Indicate.Requirement.for.Platform.Transmitting.Terminal..PTT..Power.Consumption..Watts.) %>%
  dplyr::rename(power_use = X14..Indicate.Requirement.for.Platform.Transmitting.Terminal..PTT..Power.Consumption..Watts.) %>%
  separate_rows(power_use, sep = ";") %>%
  separate_rows(mission_area, sep = "; ") %>%
  mutate(power_use = as.factor(power_use)) %>% na.omit() %>%
  group_by(mission_area, power_use) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  add_row(mission_area = "Wildlife Tracking", power_use = "5-20 Watts", survey_count = 0) %>%
  add_row(mission_area = "Buoy Tracking, Vessel Tracking, and Data Applications", power_use = "5-20 Watts", survey_count = 0) %>%
  mutate(power_use = ordered(power_use, levels = c("5-20 Watts","2-5 Watts","1-2 Watts","0.1-1 Watt"))) %>%
  arrange(power_use) %>%
  group_by(mission_area) %>%
  dplyr::summarize(power_use = power_use,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

power_use_all_msa <- power_use_all %>% select(-line_office)
power_use_MSA<-rbind(power_use_MSA, power_use_all_msa)
power_use_MSA<-power_use_MSA %>%
  group_by(mission_area) %>% mutate(msa_count = n()) %>% filter(msa_count>1)
power_use_MSA %>%
  ggplot(aes(x = power_use, y = `% Satisfied`, group = mission_area, color = mission_area, linetype = mission_area)) +
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = my_palette_msa_utility, labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.76, 0.15)) +
  scale_x_discrete(limits = rev) +
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) +  geom_hline(yintercept = 50, linetype = "dotted") +
  guides(linetype = FALSE, color = guide_legend(title = "Mission Area")) +
  labs(x = "PTT Power Consumption (Watts)")

# LO
power_use_LO<- utility %>%
 select(line_office, mission_area, X14..Indicate.Requirement.for.Platform.Transmitting.Terminal..PTT..Power.Consumption..Watts.) %>%
  dplyr::rename(power_use = X14..Indicate.Requirement.for.Platform.Transmitting.Terminal..PTT..Power.Consumption..Watts.) %>%
  separate_rows(power_use, sep = ";") %>%
  mutate(power_use = as.factor(power_use)) %>% na.omit() %>%
  group_by(line_office, power_use) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame() %>% 
  add_row(line_office = "OAR & Non-NOAA (research)", power_use = "5-20 Watts", survey_count = 0) %>%
  add_row(line_office = "NMFS", power_use = "5-20 Watts", survey_count = 0) %>%
  add_row(line_office = "NOS", power_use = "0.1-1 Watt", survey_count = 0) %>%
  mutate(power_use = ordered(power_use, levels = c("5-20 Watts","2-5 Watts","1-2 Watts","0.1-1 Watt"))) %>%
  arrange(power_use) %>%
  group_by(line_office) %>%
  dplyr::summarize(power_use = power_use,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

power_use_all_lo <- power_use_all %>% select(-mission_area)
power_use_LO<-rbind(power_use_LO, power_use_all_lo)
power_use_LO<-power_use_LO %>%
  group_by(line_office) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
power_use_LO %>%
  ggplot(aes(x = power_use, y = `% Satisfied`, group = line_office, color = line_office, linetype = line_office)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = my_palette_lo_utility, labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.85, 0.15)) +
  scale_x_discrete(limits = rev) + scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) +  geom_hline(yintercept = 50, linetype = "dotted") +
  guides(linetype = FALSE, color = guide_legend(title = "Line Office")) +
  labs(x = "PTT Power Consumption (Watts)")

#### Mass ####
mass_all<- utility %>%
  select(line_office, mission_area, X16..Maximum.Platform.Total.Mass.Requirement) %>%
  dplyr::rename(mass = X16..Maximum.Platform.Total.Mass.Requirement) %>%
  separate_rows(mass, sep = ";") %>%
  mutate(mass = as.factor(mass)) %>% na.omit() %>%
  group_by(mass) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame() %>%
  mutate(mass = ordered(mass, levels = c("1-2g","40-50g","50-70g","70-100g",">100g"))) %>%
  arrange(mass) %>%
  dplyr::summarize(mission_area = "All",
         line_office = "All",
         mass = mass,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>%
  as.data.frame()

# MSA
mass_MSA<- utility %>%
  select(line_office, mission_area, X16..Maximum.Platform.Total.Mass.Requirement) %>%
  dplyr::rename(mass = X16..Maximum.Platform.Total.Mass.Requirement) %>%
  separate_rows(mass, sep = ";") %>%
  separate_rows(mission_area, sep = "; ") %>%
  mutate(mass = as.factor(mass)) %>% na.omit() %>%
  group_by(mission_area, mass) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  add_row(mission_area = "Buoy Tracking, Vessel Tracking, and Data Applications", mass = "1-2g", survey_count = 0) %>%
  mutate(mass = ordered(mass, levels = c("1-2g","40-50g","50-70g","70-100g",">100g"))) %>%
  arrange(mass) %>%
  group_by(mission_area) %>%
  dplyr::summarize(mass = mass,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
mass_all_msa <- mass_all %>% select(-line_office)
mass_MSA<-rbind(mass_MSA, mass_all_msa)
mass_MSA<-mass_MSA %>%
  group_by(mission_area) %>% mutate(msa_count = n()) %>% filter(msa_count>1)
mass_MSA %>%
  ggplot(aes(x = mass, y = `% Satisfied`, group = mission_area, color = mission_area, linetype = mission_area)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = c("grey49","#0F1B40", "#048C8C", "#D9B18F"), labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.76, 0.13)) +
  scale_x_discrete(limits = rev) + scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) +  geom_hline(yintercept = 50, linetype = "dotted") +
  guides(linetype = FALSE, color = guide_legend(title = "Mission Area")) +
  labs(x = "Maximum Platform Total Mass")

# LO
mass_LO<- utility %>%
  select(line_office, mission_area, X16..Maximum.Platform.Total.Mass.Requirement) %>%
  dplyr::rename(mass = X16..Maximum.Platform.Total.Mass.Requirement) %>%
  separate_rows(mass, sep = ";") %>%
  mutate(mass = as.factor(mass)) %>% na.omit() %>%
  group_by(line_office, mass) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  add_row(line_office = "OAR & Non-NOAA (research)", mass = "1-2g", survey_count = 0) %>%
  mutate(mass = ordered(mass, levels = c("1-2g","40-50g","50-70g","70-100g",">100g"))) %>%
  arrange(mass) %>%
  group_by(line_office) %>%
  dplyr::summarize(mass = mass,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
mass_all_lo <- mass_all %>% select(-mission_area)
mass_LO<-rbind(mass_LO, mass_all_lo)
mass_LO<-mass_LO %>%
  group_by(line_office) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
mass_LO %>%
  ggplot(aes(x = mass, y = `% Satisfied`, group = line_office, color = line_office, linetype = line_office)) +
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = c("grey49", "#048C8C", "#D9B18F"), labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.82, 0.09)) +
  scale_x_discrete(limits = rev) + scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) +  geom_hline(yintercept = 50, linetype = "dotted") +
  guides(linetype = FALSE, color = guide_legend(title = "Line Office")) +
  labs(x = "Maximum Platform Total Mass")

#### Throughput/Bandwidth ####
bandwidth_all<- utility %>%
  select(line_office, mission_area, X18..Minimum.Throughput.or.Bandwidth.Required) %>%
  dplyr::rename(bandwidth = X18..Minimum.Throughput.or.Bandwidth.Required) %>%
  separate_rows(bandwidth, sep = ";") %>%
  mutate(bandwidth = ifelse(bandwidth == ">5000 kps (including G3, G4, G5)", ">5000 kps", bandwidth)) %>% 
  mutate(bandwidth = as.factor(bandwidth)) %>%
  na.omit() %>%
  group_by(bandwidth) %>%
  dplyr::summarize(survey_count = n()) %>%
  as.data.frame() %>%
  mutate(bandwidth = ordered(bandwidth, levels = c(">5000 kps", "5000 kps", "2400 kps","1200 kps","128 kps","9.6 kps","2400 bps","1200 bps","480 bps"))) %>%
  arrange(bandwidth) %>%
  dplyr::summarize(mission_area = "All",
         line_office = "All",
         bandwidth = bandwidth,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

# MSA
bandwidth_MSA<- utility %>%
  select(line_office, mission_area, X18..Minimum.Throughput.or.Bandwidth.Required) %>%
  dplyr::rename(bandwidth = X18..Minimum.Throughput.or.Bandwidth.Required) %>%
  separate_rows(bandwidth, sep = ";") %>%
  separate_rows(mission_area, sep = "; ") %>% 
  mutate(bandwidth = ifelse(bandwidth == ">5000 kps (including G3, G4, G5)", ">5000 kps", bandwidth)) %>% 
  mutate(bandwidth = as.factor(bandwidth)) %>%
  na.omit() %>%
  group_by(mission_area, bandwidth) %>%
  dplyr::summarize(survey_count = n()) %>%
  as.data.frame() %>% 
  add_row(mission_area = "Wildlife Tracking", bandwidth = ">5000 kps", survey_count = 0) %>%
  mutate(bandwidth = ordered(bandwidth, levels = c(">5000 kps", "5000 kps", "2400 kps","1200 kps","128 kps","9.6 kps","2400 bps","1200 bps","480 bps"))) %>%
  arrange(bandwidth) %>%
  group_by(mission_area) %>%
  dplyr::summarize(bandwidth = bandwidth,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
bandwidth_all_msa <- bandwidth_all %>% select(-line_office)
bandwidth_MSA<-rbind(bandwidth_MSA, bandwidth_all_msa)
bandwidth_MSA<-bandwidth_MSA %>%
  group_by(mission_area) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
bandwidth_MSA %>%
  ggplot(aes(x =  bandwidth, y = `% Satisfied`, group = mission_area, color = mission_area, linetype = mission_area)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = c("grey49","#0F1B40", "#D95B7D", "#048C8C", "#D9B18F"), labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.8)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.5)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.76, 0.16)) +
  scale_x_discrete(limits = rev, guide = guide_axis(n.dodge = 2)) + scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) +  
  geom_hline(yintercept = 50, linetype = "dotted") +
  guides(linetype = FALSE, color = guide_legend(title = "Mission Area")) +
  labs(x = "Minimum Throughput or Bandwidth")

# LO
bandwidth_LO<- utility %>%
  select(line_office, mission_area, X18..Minimum.Throughput.or.Bandwidth.Required) %>%
  dplyr::rename(bandwidth = X18..Minimum.Throughput.or.Bandwidth.Required) %>%
  separate_rows(bandwidth, sep = ";") %>%
    mutate(bandwidth = ifelse(bandwidth == ">5000 kps (including G3, G4, G5)", ">5000 kps", bandwidth)) %>% 
  mutate(bandwidth = as.factor(bandwidth)) %>% na.omit() %>%
  group_by(line_office, bandwidth) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  mutate(bandwidth = ordered(bandwidth, levels = c("480 bps","1200 bps","2400 bps","9.6 kps","128 kps","1200 kps","2400 kps","5000 kps",">5000 kps"))) %>%
  arrange(bandwidth) %>%
  group_by(line_office) %>%
  dplyr::summarize(bandwidth = bandwidth,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
bandwidth_all_lo <- bandwidth_all %>% select(-mission_area)
bandwidth_LO<-rbind(bandwidth_LO, bandwidth_all_lo)
bandwidth_LO<-bandwidth_LO %>%
  group_by(line_office) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
bandwidth_LO %>%
  ggplot(aes(x = bandwidth, y = `% Satisfied`, group = line_office, color = line_office, linetype = line_office)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = c("#245668", "#0D8F81", "#39AB7E", "#A9DC67", "#EDEF5D"), labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.1)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.4)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.19, 0.88)) +
  scale_x_discrete(limits = rev, guide = guide_axis(n.dodge = 2)) + scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + 
  geom_hline(yintercept = 50, linetype = "dotted") +
  guides(linetype = FALSE,  color = guide_legend(title = "Line Office")) +
  labs(x = "Minimum Throughput or Bandwidth")

#### Temporal Frequency ####
freq_all<- utility %>%
  select(line_office, mission_area, X19.b.If.fixed.time.interval..indicate.minimum.temporal.frequency.) %>%
  dplyr::rename(freq = X19.b.If.fixed.time.interval..indicate.minimum.temporal.frequency.) %>%
  separate_rows(freq, sep = ";") %>%
  mutate(freq = as.factor(freq)) %>%
  na.omit() %>%
  group_by(freq) %>%
  dplyr::summarize(survey_count = n()) %>%
  as.data.frame()%>%
  mutate(freq = ordered(freq, levels = c("5 minute","15 minute","30 minute","1 hour","6 hour","12 hour","1 day"))) %>%
  arrange(freq) %>%
  dplyr::summarize(mission_area = "All",
         line_office = "All",
         freq = freq,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>%
  as.data.frame()

# MSA
freq_MSA<- utility %>%
  select(line_office, mission_area, X19.b.If.fixed.time.interval..indicate.minimum.temporal.frequency.) %>%
  dplyr::rename(freq = X19.b.If.fixed.time.interval..indicate.minimum.temporal.frequency.) %>%
  separate_rows(freq, sep = ";") %>%
  separate_rows(mission_area, sep = "; ") %>%
  mutate(freq = as.factor(freq)) %>% na.omit() %>%
  group_by(mission_area, freq) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  mutate(freq = ordered(freq, levels = c("5 minute","15 minute","30 minute","1 hour","6 hour","12 hour","1 day"))) %>%
  arrange(freq) %>%
  group_by(mission_area) %>%
  dplyr::summarize(freq = freq,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
freq_all_msa <- freq_all %>% select(-line_office)
freq_MSA<-rbind(freq_MSA, freq_all_msa)
freq_MSA<-freq_MSA %>%
  group_by(mission_area) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
freq_MSA %>%
  ggplot(aes(x = freq, y = `% Satisfied`, group = mission_area, color = mission_area, linetype = mission_area)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = c("#245668", "#0D8F81", "#39AB7E", "#A9DC67", "#EDEF5D"), labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.4)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.24, 0.87)) +
  scale_x_discrete(limits = rev) + scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + geom_hline(yintercept = 50, linetype = "dotted") +
  guides(linetype = FALSE, color = guide_legend(title = "Mission Area")) +
  labs(x = "Minimum Temporal Frequency")

# LO
freq_LO<- utility %>%
  select(line_office, mission_area, X19.b.If.fixed.time.interval..indicate.minimum.temporal.frequency.) %>%
  dplyr::rename(freq = X19.b.If.fixed.time.interval..indicate.minimum.temporal.frequency.) %>%
  separate_rows(freq, sep = ";") %>%
  mutate(freq = as.factor(freq)) %>%
  na.omit() %>%
  group_by(line_office, freq) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  mutate(freq = ordered(freq, levels = c("5 minute","15 minute","30 minute","1 hour","6 hour","12 hour","1 day"))) %>%
  arrange(freq) %>%
  group_by(line_office) %>%
  dplyr::summarize(freq = freq,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
freq_all_lo <- freq_all %>% select(-mission_area)
freq_LO<-rbind(freq_LO, freq_all_lo)
freq_LO<-freq_LO %>%
  group_by(line_office) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
freq_LO %>%
  ggplot(aes(x = freq, y = `% Satisfied`, group = line_office, color = line_office, linetype = line_office)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = c("#245668", "#0D8F81", "#6EC574", "#A9DC67", "#EDEF5D"), labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.4)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.19, 0.88)) +
  scale_x_discrete(limits = rev) + scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) +  geom_hline(yintercept = 50, linetype = "dotted") +
  guides(linetype = FALSE, color = guide_legend(title = "Line Office")) +
  labs(x = "Minimum Temporal Frequency")

#### Longest Temporal Frequency to Transmit Data ####
transmit_freq_all<- utility %>%
  dplyr::select(line_office, mission_area, X19.c.If.ad.hoc.variable.immediate.send.on.platform.availability..indicate.longest.permissible.communications.temporal.window.to.transmit.data.required) %>%
  dplyr::rename(transmit_freq =  X19.c.If.ad.hoc.variable.immediate.send.on.platform.availability..indicate.longest.permissible.communications.temporal.window.to.transmit.data.required) %>%
  separate_rows(transmit_freq, sep = ";") %>%
  mutate(transmit_freq = as.factor(transmit_freq)) %>% na.omit() %>%
  group_by(transmit_freq) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  mutate(transmit_freq = ordered(transmit_freq, levels = c("1 second","3 seconds","10 seconds","75 seconds", ">75 seconds"))) %>%
  arrange(transmit_freq) %>%
  dplyr::summarize(mission_area = "All",
         line_office = "All",
         transmit_freq = transmit_freq, 
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()

# MSA
transmit_freq_MSA<- utility %>%
  dplyr::select(line_office, mission_area, X19.c.If.ad.hoc.variable.immediate.send.on.platform.availability..indicate.longest.permissible.communications.temporal.window.to.transmit.data.required) %>%
  separate_rows(mission_area, sep = "; ") %>%
  dplyr::rename(transmit_freq =  X19.c.If.ad.hoc.variable.immediate.send.on.platform.availability..indicate.longest.permissible.communications.temporal.window.to.transmit.data.required) %>%
  separate_rows(transmit_freq, sep = ";") %>%
  mutate(transmit_freq = as.factor(transmit_freq)) %>% na.omit() %>%
  group_by(mission_area, transmit_freq) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame() %>%
  add_row(mission_area = "Meteorology and Climatology", transmit_freq = "1 second", survey_count = 0) %>%
  add_row(mission_area = "Oceanography, Hydrography, Pollution/Water Quality, and Sea Ice", transmit_freq = "1 second", survey_count = 0) %>%
  mutate(transmit_freq = ordered(transmit_freq, levels = c("1 second","3 seconds","10 seconds","75 seconds", ">75 seconds"))) %>% arrange(transmit_freq) %>% group_by(mission_area) %>%
  dplyr::summarize(transmit_freq = transmit_freq,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
transmit_freq_all_msa <- transmit_freq_all %>% select(-line_office)
transmit_freq_MSA<-rbind(transmit_freq_MSA, transmit_freq_all_msa)
transmit_freq_MSA<-transmit_freq_MSA %>%
  group_by(mission_area) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
transmit_freq_MSA %>%
  ggplot(aes(x = transmit_freq, y = `% Satisfied`, group = mission_area, color = mission_area, linetype = mission_area)) + geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = c("#245668", "#0D8F81", "#39AB7E", "#A9DC67", "#EDEF5D"), labels = function(x) str_wrap(x, width = 40)) +theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
        axis.text = element_text(face = "bold", colour = "black",size = rel(1.2)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.4)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.78, 0.13)) +
  scale_x_discrete(limits = rev) + geom_hline(yintercept = 50, linetype = "dotted") +
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + 
  guides(linetype = FALSE, color = guide_legend(title = "Mission Area")) +
  labs(x = "Longest Communications Temporal Window to Transmit Data")

# LO
transmit_freq_LO<- utility %>%
  dplyr::select(line_office, mission_area, X19.c.If.ad.hoc.variable.immediate.send.on.platform.availability..indicate.longest.permissible.communications.temporal.window.to.transmit.data.required) %>%
  dplyr::rename(transmit_freq =  X19.c.If.ad.hoc.variable.immediate.send.on.platform.availability..indicate.longest.permissible.communications.temporal.window.to.transmit.data.required) %>%
  separate_rows(transmit_freq, sep = ";") %>%
  mutate(transmit_freq = as.factor(transmit_freq)) %>% na.omit() %>%
  group_by(line_office, transmit_freq) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame() %>%
  add_row(line_office = "OAR & Non-NOAA (research)", transmit_freq = "1 second", survey_count = 0) %>%
  mutate(transmit_freq = ordered(transmit_freq, levels = c("1 second","3 seconds","10 seconds","75 seconds", ">75 seconds"))) %>% arrange(transmit_freq) %>% group_by(line_office) %>%
  dplyr::summarize(transmit_freq = transmit_freq,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
transmit_freq_all_lo <- transmit_freq_all %>% select(-mission_area)
transmit_freq_LO<-rbind(transmit_freq_LO, transmit_freq_all_lo)
transmit_freq_LO<-transmit_freq_LO %>%
  group_by(line_office) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
transmit_freq_LO %>%
  ggplot(aes(x = transmit_freq, y = `% Satisfied`, group = line_office, color = line_office, linetype = line_office)) + 
  geom_line(size = 1.2) + scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = c("#245668", "#0D8F81", "#A9DC67", "#EDEF5D"), labels = function(x) str_wrap(x, width = 40)) + theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.4)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.81, 0.11)) +
  scale_x_discrete(limits = rev) + 
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + 
  geom_hline(yintercept = 50, linetype = "dotted") +
  guides(linetype = FALSE, color = guide_legend(title = "Line Office")) +
  labs(x = "Longest Communications Temporal Window to Transmit Data")

#### Latency ####
latency_all<- utility %>%
  dplyr::select(line_office, mission_area, X20..What.is.the.longest.acceptable.temporal.latency.between.transmission.of.data.from.platform.to.receipt.at.central.data.center.or.receiving.organization) %>%
  dplyr::rename(latency =  X20..What.is.the.longest.acceptable.temporal.latency.between.transmission.of.data.from.platform.to.receipt.at.central.data.center.or.receiving.organization) %>%
  separate_rows(latency, sep = ";") %>%
  mutate(latency = as.factor(latency)) %>%
  na.omit() %>%
  group_by(latency) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  mutate(latency = ordered(latency, levels = c("< 1 second","1-10 seconds","10-30 seconds","30 seconds to 1 minute","1-10 minutes","10-60 minutes","1-2 hours","2-3 hours","12-24 hours",">1 day"))) %>%
  arrange(latency) %>%
  dplyr::summarize(mission_area = "All",
         line_office = "All",
         latency = latency,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100)%>% as.data.frame()

# MSA
latency_MSA<- utility %>%
  dplyr::select(line_office, mission_area, X20..What.is.the.longest.acceptable.temporal.latency.between.transmission.of.data.from.platform.to.receipt.at.central.data.center.or.receiving.organization) %>%
  separate_rows(mission_area, sep = "; ") %>%
  dplyr::rename(latency =  X20..What.is.the.longest.acceptable.temporal.latency.between.transmission.of.data.from.platform.to.receipt.at.central.data.center.or.receiving.organization) %>%
  separate_rows(latency, sep = ";") %>%
  mutate(latency = as.factor(latency)) %>% na.omit() %>%
  group_by(mission_area, latency) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame() %>%
  add_row(mission_area = "Meteorology and Climatology", latency = "< 1 second", survey_count = 0) %>%
  add_row(mission_area = "Oceanography, Hydrography, Pollution/Water Quality, and Sea Ice",latency = "< 1 second", survey_count = 0) %>%
  add_row(mission_area = "Wildlife Tracking",latency = "< 1 second", survey_count = 0) %>%
  mutate(latency = ordered(latency, levels = c("< 1 second","1-10 seconds","10-30 seconds","30 seconds to 1 minute","1-10 minutes","10-60 minutes","1-2 hours","2-3 hours","12-24 hours",">1 day"))) %>%
  arrange(latency) %>%
  group_by(mission_area) %>%
  dplyr::summarize(latency = latency,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
latency_all_msa <- latency_all %>% select(-line_office)
latency_MSA<-rbind(latency_MSA, latency_all_msa)
latency_MSA<-latency_MSA %>%
  group_by(mission_area) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
latency_MSA %>%
  ggplot(aes(x = latency, y = `% Satisfied`, group = mission_area, color = mission_area, linetype = mission_area)) +
  geom_line(size = 1.2) + scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = c("#245668", "#0D8F81", "#39AB7E", "#A9DC67", "#EDEF5D"), labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.1)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.4)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.14)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.22, 0.86)) +
  scale_x_discrete(limits = rev, guide = guide_axis(n.dodge = 2)) + 
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + 
  geom_hline(yintercept = 50, linetype = "dotted") +
  guides(linetype = FALSE, color = guide_legend(title = "Mission Area")) +
  labs(x = "Longest Temporal Latency")

# LO
latency_LO<- utility %>%
  dplyr::select(line_office, mission_area, X20..What.is.the.longest.acceptable.temporal.latency.between.transmission.of.data.from.platform.to.receipt.at.central.data.center.or.receiving.organization) %>%
  dplyr::rename(latency =  X20..What.is.the.longest.acceptable.temporal.latency.between.transmission.of.data.from.platform.to.receipt.at.central.data.center.or.receiving.organization) %>%
  separate_rows(latency, sep = ";") %>%
  mutate(latency = as.factor(latency)) %>% na.omit() %>%
  group_by(line_office, latency) %>%
  summarize(survey_count = n()) %>% as.data.frame()%>%
  add_row(line_office = "OAR & Non-NOAA (research)", latency = "< 1 second", survey_count = 0) %>%
  add_row(line_office = "NOS", latency = "< 1 second", survey_count = 0) %>%
  add_row(line_office = "NWS", latency = "< 1 second", survey_count = 0) %>%
  add_row(line_office = "NMFS", latency = "< 1 second", survey_count = 0) %>%
  mutate(latency = ordered(latency, levels = c("< 1 second","1-10 seconds","10-30 seconds","30 seconds to 1 minute","1-10 minutes","10-60 minutes","1-2 hours","2-3 hours","12-24 hours",">1 day"))) %>%
  arrange(latency) %>%
  group_by(line_office) %>%
  dplyr::summarize(latency = latency,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
latency_all_lo <- latency_all %>% select(-mission_area)
latency_LO<-rbind(latency_LO, latency_all_lo)
latency_LO<-latency_LO %>%
  group_by(line_office) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
latency_LO %>%
  ggplot(aes(x = latency, y = `% Satisfied`, group = line_office, color = line_office, linetype = line_office)) + geom_line(size = 1.2) +
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = c("#245668", "#0D8F81", "#39AB7E", "#6EC574", "#A9DC67", "#EDEF5D"), labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.1)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold",size = rel(1.4)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.15)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.17, 0.87)) +
  scale_x_discrete(limits = rev, guide = guide_axis(n.dodge = 2)) +
  geom_hline(yintercept = 50, linetype = "dotted") + 
  scale_y_continuous(limits = c(0, 100), expand = c(0.01,0)) + 
  guides(linetype = FALSE, color = guide_legend(title = "Line Office")) +
  labs(x = "Longest Temporal Latency")
```

Q35
```{r}
cost<- telemetry_new %>%
  dplyr::select(line_office, mission_area, X35..My.program.s.current.subscription.per.telemetry.circuit.or.PTT.unit.per.month.is.approximately) %>%
  dplyr::rename(cost_per_month = X35..My.program.s.current.subscription.per.telemetry.circuit.or.PTT.unit.per.month.is.approximately) %>%
  mutate_all(na_if, "Depends on data usage") %>% na.omit() %>%
  mutate(cost_per_month = as.factor(cost_per_month)) %>% na.omit() 


cost_all <- cost %>%
  select(-line_office) %>%
  group_by(cost_per_month) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  mutate(cost_per_month=ordered(cost_per_month, levels=c(">$10,000","$1,001-$10,000","$501-$1,000","$101-$500","$61-$100","$41-$60","$21-$40","$1-$20"))) %>%
  arrange(cost_per_month) %>%
  dplyr::summarize(mission_area = "All",
         line_office = "All",
         cost_per_month = cost_per_month,
         cum_count = cumsum(survey_count),
         cum_diff = cum_count - survey_count,
         max = max(cum_count),
         accumulated = max - cum_diff,
         `% Satisfied` = (accumulated/max)*100)
#MSA
cost_msa<- cost %>%
  select(-line_office) %>%
  separate_rows(mission_area, sep = "; ") %>%
  group_by(mission_area, cost_per_month) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  add_row(mission_area = "Wildlife Tracking", cost_per_month = ">$10,000", survey_count = 0) %>%
  add_row(mission_area = "Wildlife Tracking", cost_per_month = "$1-$20", survey_count = 0) %>%
  mutate(cost_per_month = ordered(cost_per_month, levels=c(">$10,000","$1,001-$10,000","$501-$1,000","$101-$500","$61-$100","$41-$60","$21-$40","$1-$20"))) %>%
  arrange(cost_per_month) %>%
  group_by(mission_area) %>%
  dplyr::summarize(cost_per_month = cost_per_month,
            cum_count = cumsum(survey_count),
            cum_diff = cum_count - survey_count,
            max = max(cum_count),
            accumulated = max - cum_diff,
            `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
cost_all_msa <- cost_all %>% select(-line_office)
cost_msa<-rbind(cost_msa, cost_all_msa)
cost_msa<-cost_msa %>%
  group_by(mission_area) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
cost_msa %>%
  ggplot(aes(x = cost_per_month, y = `% Satisfied`, group = mission_area, color = mission_area, linetype = mission_area)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid"))+
  scale_color_manual(values = c("#245668", "#0D8F81", "#39AB7E", "#A9DC67", "#EDEF5D"), labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.4)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.22, 0.87)) +
  geom_hline(yintercept = 50, linetype = "dotted")+ scale_x_discrete(limits = rev)+ ylim(0,100) +
  guides(linetype = FALSE, color = guide_legend(title = "Mission Area")) +
  labs(x = "Cost per Month")

#LO
cost_lo<- cost %>%
  select(-mission_area) %>%
  group_by(line_office, cost_per_month) %>%
  dplyr::summarize(survey_count = n()) %>% as.data.frame()%>%
  add_row(line_office = "NMFS", cost_per_month = ">$10,000", survey_count = 0) %>%
  add_row(line_office = "NOS", cost_per_month = ">$10,000", survey_count = 0) %>%
  add_row(line_office = "OAR & Non-NOAA (research)", cost_per_month = ">$10,000", survey_count = 0) %>%
  mutate(cost_per_month = ordered(cost_per_month, levels=c(">$10,000","$1,001-$10,000","$501-$1,000","$101-$500","$61-$100","$41-$60","$21-$40","$1-$20"))) %>% 
  arrange(cost_per_month) %>%
  group_by(line_office) %>%
  dplyr::summarize(cost_per_month = cost_per_month,
            cum_count = cumsum(survey_count),
            cum_diff = cum_count - survey_count,
            max = max(cum_count),
            accumulated = max - cum_diff,
            `% Satisfied` = (accumulated/max)*100) %>% as.data.frame()
cost_all_lo <- cost_all %>% select(-mission_area)
cost_lo<-rbind(cost_lo, cost_all_lo)
cost_lo<-cost_lo %>%
  group_by(line_office) %>% mutate(lo_count = n()) %>% filter(lo_count>1)
cost_lo %>%
  ggplot(aes(x = cost_per_month, y = `% Satisfied`, group = line_office, color = line_office, linetype = line_office)) + 
  geom_line(size = 1.2)+
  scale_linetype_manual(values = c("dashed", "solid", "solid", "solid", "solid","solid"))+
  scale_color_manual(values = c("#245668","#0D8F81","#39AB7E","#A9DC67","#EDEF5D"), labels = function(x) str_wrap(x, width = 40)) +
  theme_classic() +
  theme(axis.title = element_text(face = "bold", size = rel(1.4)),
        axis.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        axis.line = element_line(size = 1),
        legend.title = element_text(face = "bold", size = rel(1.4)),
        legend.text = element_text(face = "bold", colour = "black", size = rel(1.2)),
        legend.key.size = unit(1.2,'lines'),
        legend.position = c(0.22, 0.87)) +
  geom_hline(yintercept = 50, linetype = "dotted")+ scale_x_discrete(limits = rev)+ ylim(0,100) +
  guides(linetype = FALSE, color = guide_legend(title = "Line Office")) +
  labs(x = "Cost per Month")
```


Treemaps
```{r}
#install.packages("remotes")
#remotes::install_github("d3treeR/d3treeR")

# Mission Area
telemetry_msa_tree <- telemetry_new %>%
  separate_rows(mission_area, sep = "; ") %>%
  group_by(mission_area) %>%
  summarize(msa_count = n()) %>%
  as.data.frame() %>%
  mutate(label = paste0(mission_area,"\n(",msa_count,")"))

treemap(telemetry_msa_tree,
        index = c("label"),
        vSize = c("msa_count"),
        type = "index",
        fontcolor.labels = c("black","black","black","black"),
        fontfamily.labels = c("sans","sans","sans","sans"),
        title = "Mission Areas",
        palette = c( "#0D8F81", "#39AB7E", "#A9DC67", "#EDEF5D"))

# LO
telemetry_lo_tree <- telemetry_new %>%
  group_by(line_office) %>%
  summarize(lo_count = n()) %>%
  as.data.frame() %>%
  mutate(label = paste0(line_office,"\n(",lo_count,")"))

treemap(telemetry_lo_tree,
        index = c("label"),
        vSize = c("lo_count"),
        type = "index",
        fontcolor.labels = c("black","black","black","black","black"),
        fontfamily.labels = c("sans","sans","sans","sans","sans"),
        title = "Line Offices",
        palette = c("#0D8F81", "#39AB7E", "#6EC574", "#A9DC67", "#EDEF5D"))

```


Q9a: Telemetry Provider (by MSA & LO)
```{r}
tel_provider <- telemetry_new %>%
  select(mission_area, line_office, X9.a.Current.telemetry.communications.provider..technology.and.priority..primary.or.backup...GSM.Cell..SMS..:X9.a.Current.telemetry.communications.provider..technology.and.priority..primary.or.backup...Satellite.) %>%
  rename(GSM_Cell_SMS = X9.a.Current.telemetry.communications.provider..technology.and.priority..primary.or.backup...GSM.Cell..SMS..) %>%
  rename(VHF_UHF = X9.a.Current.telemetry.communications.provider..technology.and.priority..primary.or.backup...VHF.or.UHF.) %>%
  rename(Optical_Tag = 	X9.a.Current.telemetry.communications.provider..technology.and.priority..primary.or.backup...Optical.Tag.) %>%
  rename(Wired_WAN_LAN =X9.a.Current.telemetry.communications.provider..technology.and.priority..primary.or.backup...Wired.WAN.LAN.) %>%
  rename(Satellite = X9.a.Current.telemetry.communications.provider..technology.and.priority..primary.or.backup...Satellite.) %>%
  mutate_all(na_if, "")%>%
  pivot_longer(3:7, names_to = "provider", values_to = "type") %>%
  separate_rows(type, sep = ";") %>%
  separate_rows(mission_area, sep = "; ") %>%
  filter(!is.na(type))%>%
  mutate(provider = replace(provider, provider == "VHF_UHF", "VHF/UHF")) %>%
  mutate(provider = replace(provider, provider == "GSM_Cell_SMS", "GSM/Cell(SMS)")) %>%
  mutate(provider = replace(provider, provider == "Optical_Tag", "Optical/Tag")) %>%
  mutate(provider = replace(provider, provider == "Wired_WAN_LAN", "Wired WAN/LAN"))

tel_provider_msa <- tel_provider %>%
  select(mission_area, provider, type) %>%
  group_by(mission_area, provider, type) %>%
  summarize(msa_provider_count = n()) %>%
  as.data.frame()

treemap(tel_provider_msa,
        index = c("mission_area","type", "provider"),
        vSize = "msa_provider_count",
        type = "index",
        bg.labels = c("transparent"),
        border.col = c("white","white","black"),
        palette = "Set2",
        fontcolor.labels = c("white","transparent","white"),
        align.labels = list(
          c("right","top"),
          c("left","top"),
          c("center","center")
        ),
        border.lwds = c(10,6,2),
        title = "")



tel_provider_lo <- tel_provider %>%
  select(line_office, provider, type) %>%
  group_by(line_office, provider, type) %>%
  summarize(lo_provider_count = n()) %>%
  as.data.frame()

treemap(tel_provider_lo,
        index = c("line_office","type", "provider"),
        vSize = "lo_provider_count",
        type = "index",
        bg.labels = c("transparent"),
        border.col = c("white","white","black"),
        palette = "Set2",
        fontcolor.labels = c("white","transparent","white"),
        align.labels = list(
          c("right","top"),
          c("left","top"),
          c("center","center")
        ),
        border.lwds = c(10,6,2),
        title = "")
```

Q9b: Satellite Provider
```{r}
sat_provider_all <- telemetry_new %>%
  dplyr::select(line_office, mission_area, X9.b.If.Communications.Type.is..Satellite...primary.or.backup...identify.current.satellite.communications.provider.s.) %>%
  dplyr::rename(sat_provider = X9.b.If.Communications.Type.is..Satellite...primary.or.backup...identify.current.satellite.communications.provider.s.) %>%
  mutate(sat_provider = replace(sat_provider, sat_provider == "",NA)) %>%
  filter(!is.na(sat_provider)) %>%
  separate_rows(sat_provider, sep =";")

sat_provider_lo <- sat_provider_all %>%
  dplyr::select(-mission_area) %>%
  group_by(line_office, sat_provider) %>%
  summarize(sat_provider_count = n())

ggplot(sat_provider_lo, aes(x = reorder(sat_provider, sat_provider_count), y = sat_provider_count, fill = stringr::str_wrap(line_office,30))) +
   geom_bar(position = "stack", stat = "identity") +
   theme_classic() +
   theme(axis.title = element_text(face = "bold", size = rel(1.8)),
         axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
         axis.line = element_line(size = 1),
         legend.title = element_text(face = "bold", size = rel(1.6)),
         legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
         legend.position = c(0.22, 0.89)) +
  labs(x = "Satellite Provider", y = "Count", fill = "Line Office") +
  scale_fill_manual(values = my_palette_lo)


sat_provider_msa <- sat_provider_all %>%
  dplyr::select(-line_office) %>%
  separate_rows(mission_area, sep = "; ") %>%
  group_by(mission_area, sat_provider) %>%
  summarize(sat_provider_count = n())

ggplot(sat_provider_msa, aes(x = reorder(sat_provider, sat_provider_count), y = sat_provider_count, fill = stringr::str_wrap(mission_area, 40))) +
   geom_bar(position = "stack", stat = "identity") +
   theme_classic() +
   theme(axis.title = element_text(face = "bold", size = rel(1.8)),
         axis.text = element_text(face = "bold", colour = "black", size = rel(1.6)),
         axis.line = element_line(size = 1),
         legend.title = element_text(face = "bold", size = rel(1.6)),
         legend.text = element_text(face = "bold", colour = "black", size = rel(1.4)),
         legend.position = c(0.3, 0.88)) +
  labs(x = "Satellite Provider", y = "Count", fill = "Mission Area") +
  scale_fill_manual(values = my_palette_msa)
```


Q9 v Q36
```{r}
####LO####
tel_provider_current<- telemetry_new %>%
  select(line_office, Adapted9) %>% 
  mutate(Adapted9 = replace(Adapted9, Adapted9 == "",NA)) %>%
  dplyr::rename(provider = Adapted9) %>%
  separate_rows(provider, sep = ";") %>%
  drop_na(provider) %>%
  mutate(provider_type = "current_provider") %>%
  mutate(total = length(provider_type)) %>%
  group_by(line_office) %>%
  dplyr::summarise(length_lo = n(),
            provider = provider,
            provider_type = provider_type,
            total = total) %>%
  as.data.frame() %>%
  group_by(line_office, provider) %>%
  dplyr::summarise(current_length_provider = n(),
            current_length_lo = length_lo,
            current_total = total,
            current_pcent = (current_length_provider/current_length_lo)*100) %>%
  distinct(line_office, provider, .keep_all = TRUE) %>%View()

tel_provider_future <-  telemetry_new %>%
  dplyr::select(line_office, X36..What.statement.best.characterizes.your.program.s.future...post.2027..plans.for.telemetry.service.provider.s.) %>%
  dplyr::rename(provider = X36..What.statement.best.characterizes.your.program.s.future...post.2027..plans.for.telemetry.service.provider.s.) %>%
  separate_rows(provider, sep = ";") %>%
  mutate(provider_type = "future_provider") %>%
  mutate(total = length(provider_type)) %>%
  group_by(line_office) %>%
  dplyr::summarise(length_lo = n(),
            provider = provider,
            provider_type = provider_type,
            total = total) %>%
  as.data.frame() %>%
  group_by(line_office, provider) %>%
  dplyr::summarise(future_length_provider = n(),
            future_length_lo = length_lo,
            future_total = total,
            future_pcent = (future_length_provider/future_length_lo)*100)%>%
  distinct(line_office, provider, .keep_all = TRUE)

tel_provider_comp_lo<- tel_provider_current %>%
  full_join(tel_provider_future, by = c("line_office","provider")) %>%
  select(line_office, provider, current_pcent, future_pcent) %>%
  mutate(current_pcent = replace(current_pcent, is.na(current_pcent), 0)) %>%
  mutate(future_pcent = replace(future_pcent, is.na(future_pcent), 0)) %>%
  mutate(provider = replace(provider, provider == "Multiple telemetry providers to manage budget predictability and accessibility risk", "Multiple providers")) %>%
  mutate(provider = replace(provider, provider == "Don't know which telemetry provider our program will use", "Don't know")) %>%
  mutate(pcent_change = future_pcent - current_pcent)

ggplot(data = tel_provider_comp_lo, aes(x = stringr::str_wrap(provider, 12), y = stringr::str_wrap(line_office, 10), fill = pcent_change)) +
  geom_tile() +
  scale_fill_gradient2(midpoint = 0, low = "blue3", mid = "white", high = "red4") +
  geom_tile(colour = "white", size = 0.25) +
  labs(y = "Line Office", x = "Telemetry Provider", fill = "% Change") +
  theme(axis.text = element_text(colour = "black", size = rel(1.4), face = "bold"),
        axis.title = element_text(colour = "black", size = rel(1.8), face = "bold"),
        legend.title = element_text(face = "bold", size = rel(1.8)),
        legend.text = element_text(colour = "black", size = rel(1.5), face = "bold"),
        panel.background = element_rect( colour = "white", fill = "white"),
        panel.border = element_rect(colour = "black", fill = "transparent", size = 1),
        axis.line = element_line(colour = "black", size = 1))

####MSA####
tel_provider_current_msa<- telemetry_new %>%
  select(mission_area, Adapted9) %>% 
  separate_rows(mission_area, sep = "; ") %>%
  mutate(Adapted9 = replace(Adapted9, Adapted9 == "",NA)) %>%
  dplyr::rename(provider = Adapted9) %>%
  separate_rows(provider, sep = ";") %>%
  drop_na(provider) %>%
  mutate(provider_type = "current_provider") %>%
  mutate(total = length(provider_type)) %>%
  group_by(mission_area) %>%
  dplyr::summarise(length_msa = n(),
            provider = provider,
            provider_type = provider_type,
            total = total) %>%
  as.data.frame() %>%
  group_by(mission_area, provider) %>%
  dplyr::summarise(current_length_provider = n(),
            current_length_msa = length_msa,
            current_total = total,
            current_pcent = (current_length_provider/current_length_msa)*100) %>%
  distinct(mission_area, provider, .keep_all = TRUE)

tel_provider_future_msa <-  telemetry_new %>%
  dplyr::select(mission_area, X36..What.statement.best.characterizes.your.program.s.future...post.2027..plans.for.telemetry.service.provider.s.) %>%
  dplyr::rename(provider = X36..What.statement.best.characterizes.your.program.s.future...post.2027..plans.for.telemetry.service.provider.s.) %>%
  separate_rows(mission_area, sep = "; ") %>%
  separate_rows(provider, sep = ";") %>%
  mutate(provider_type = "future_provider") %>%
  mutate(total = length(provider_type)) %>%
  group_by(mission_area) %>%
  dplyr::summarise(length_msa = n(),
            provider = provider,
            provider_type = provider_type,
            total = total) %>%
  as.data.frame() %>%
  group_by(mission_area, provider) %>%
  dplyr::summarise(future_length_provider = n(),
            future_length_msa = length_msa,
            future_total = total,
            future_pcent = (future_length_provider/future_length_msa)*100)%>%
  distinct(mission_area, provider, .keep_all = TRUE)

tel_provider_comp_msa<- tel_provider_current_msa %>%
  full_join(tel_provider_future_msa, by = c("mission_area","provider")) %>%
  select(mission_area, provider, current_pcent, future_pcent) %>%
  mutate(current_pcent = replace(current_pcent, is.na(current_pcent), 0)) %>%
  mutate(future_pcent = replace(future_pcent, is.na(future_pcent), 0)) %>%
  mutate(provider = replace(provider, provider == "Multiple telemetry providers to manage budget predictability and accessibility risk", "Multiple providers")) %>%
  mutate(provider = replace(provider, provider == "Don't know which telemetry provider our program will use", "Don't know")) %>%
  mutate(pcent_change = future_pcent - current_pcent)

ggplot(data = tel_provider_comp_msa, aes(x = stringr::str_wrap(provider, 12), y = stringr::str_wrap(mission_area, 15), fill = pcent_change)) +
  geom_tile() +
  scale_fill_gradient2(midpoint = 0, low = "blue3", mid = "white", high = "red4") +
  geom_tile(colour = "white", size = 0.25) +
  labs(y = "Mission Area", x = "Telemetry Provider", fill = "% Change") +
  theme(axis.text = element_text(colour = "black", size = rel(1.4), face = "bold"),
        axis.title = element_text(colour = "black", size = rel(1.8), face = "bold"),
        legend.title = element_text(face = "bold", size = rel(1.8)),
        legend.text = element_text(colour = "black", size = rel(1.5), face = "bold"),
        panel.background = element_rect( colour = "white", fill = "white"),
        panel.border = element_rect(colour = "black", fill = "transparent", size = 1),
        axis.line = element_line(colour = "black", size = 1))

```


```{r}
ggplot(tel_provider, aes(fill = provider, y = response_count, x = type)) +
  geom_bar(position = position_dodge2(width = 0.9, preserve = "single"), stat = "identity") +
  labs(y = "Count", x = "Priority", fill = "Telemetry Provider") +
  theme(axis.line = element_line(size = 1.0, colour = "black"),
        panel.background = element_rect(fill = "white"),
        axis.text = element_text(colour = "black"),
        axis.title = element_text(colour = "black") +
  scale_fill_viridis(discrete = TRUE)


sat_provider <- telemetry %>%
  select(X9.b.If.Communications.Type.is..Satellite...primary.or.backup...identify.current.satellite.communications.provider.s.) %>%
  rename( satellite_provider = X9.b.If.Communications.Type.is..Satellite...primary.or.backup...identify.current.satellite.communications.provider.s.) %>%
  separate_rows(satellite_provider, sep = ";") %>%
  group_by(satellite_provider) %>%
  summarize(response_count = n()) %>%
  as.data.frame()
sat_provider$fraction <- sat_provider$response_count/sum(sat_provider$response_count)
sat_provider$ymax<-cumsum(sat_provider$fraction)
sat_provider$ymin<-c(0,head(sat_provider$ymax, n=-1))
sat_provider$labelPosition<-(sat_provider$ymax + sat_provider$ymin)/2
sat_provider$label<-paste0(sat_provider$satellite_provider,"\n", round(sat_provider$fraction*100, digits =1),"%")

ggplot(sat_provider, aes(ymax = ymax, ymin = ymin, xmax = 4, xmin = 3, fill = satellite_provider)) +
  geom_rect()+
  geom_text(x=1.7, aes(y=labelPosition, label = label, color = satellite_provider), size = 3.1)+
  scale_fill_manual(values = c("#238b8c","#2cb0b1","#3dcdce","#87e0e1"))+
  scale_color_manual(values = c("black","black","black","black"))+
  coord_polar(theta = "y")+
  xlim(c(-1, 4))+
  theme_void()+
  theme(legend.position = "none")
```


